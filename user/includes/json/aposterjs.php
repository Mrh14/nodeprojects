<?phpinclude('config.php');$suc ='1';$er='0';$err='';$duree = 0;$dta ='';if($_COOKIE['usertype']=='admin' ){$sql= '9999 <> ?'; $sql2= '9999 <> ?';$sql3 ='9999 <> ?' ;}else{$sql= 'iduser = ?';$sql2= 'idCompte = ?';$sql3= 'operateur = ?';};//ajouter un nouveau clientif(isset($_POST["datas"])){$obj = json_decode($_POST["datas"]);    $iduser=trim(strip_tags($obj->iduser));    $val=trim(strip_tags($obj->val));    $abs=trim(strip_tags($obj->abs));    $emp=trim(strip_tags($obj->emp));    $datedebut=trim(strip_tags($obj->datedebut));    $datefin=trim(strip_tags($obj->datefin));    $idfiche=trim(strip_tags($obj->idfiche));if($er == '0'){    $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d H:i', strtotime($date));    $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d H:i', strtotime($date));    if($val == '1'){$req1=$bdd->prepare('insert into absence(typeAbsence,date1,date2,fiche,idop) values(?,?,?,?,?)');        $req2=$bdd->prepare('select * from absence as a inner join users as b where a.idop = b.idCompte and a.idabs = ? group by a.idabs');}    else if ($val == '2'){$req1=$bdd->prepare('insert into Astreinte(nature_as,debutdate,findate,afiche,idop_as) values(?,?,?,?,?)');        $req2=$bdd->prepare('select * from astreinte as a inner join users as b where a.idop_as = b.idCompte and a.id_as = ? group by a.id_as');}    $req1->execute(array($abs,$datedebut,$datefin,intval($idfiche),intval($emp)));    $id = $bdd->lastInsertId();    $req2->execute(array(intval($id)));    $dta1 = $req2->fetchAll(\PDO::FETCH_ASSOC);    $newtabx= array(); foreach($dta1 as $key => $value) {        $newtabx[$key] = $value;        $newtab2 = array();        foreach ($newtabx[$key] as $key2 => $value2) {            $newtab2[$key2] = $value2;        }        if($val == '1'){ $dta = '<tr data-id="'.$newtab2['idabs'].'"><th scope="row">'.$newtab2['idabs'].'</th><td scope="row">'.$newtab2['typeAbsence'].'</td><td scope="row">'.$newtab2['nomprenom'].'</td><td><b class="text-primary">de</b> '.date('Y-m-d H:i', strtotime($newtab2['date1'])).' <b class="text-primary">à</b>  '.date('Y-m-d H:i', strtotime($newtab2['date2'])).' </td><td>'.$newtab2['adresse'].'</td><td>'.$newtab2['email'].'</td><td>'.$newtab2['tel'].'</td><td>'.$newtab2['role'].'</td>                   <td><form action="absences.php?edit='.$newtab2['idabs'].'" id="del3" method="post"><a title="Modifier" class="typcn typcn-edit  mdi-24px text-warning" id="dalf" data-id="'.$newtabx[$key]['idabs'].'"></a></form>                   <form action="#" id="del1" method="post"><a title="supprimer" class="typcn typcn-delete mdi-24px text-danger"  id="dell" data-id="'.$newtabx[$key]['idabs'].'"></a></form></td></tr>';}        elseif($val == '2'){ $dta = '<tr data-id="'.$newtab2['id_as'].'"><th scope="row">'.$newtab2['id_as'].'</th><td scope="row">'.$newtab2['nature_as'].'</td><td scope="row">'.$newtab2['nomprenom'].'</td><td><b class="text-primary">de</b> '.date('Y-m-d H:i', strtotime($newtab2['debutdate'])).' <b class="text-primary">à</b>  '.date('Y-m-d H:i', strtotime($newtab2['findate'])).' </td><td>'.$newtab2['adresse'].'</td><td>'.$newtab2['email'].'</td><td>'.$newtab2['tel'].'</td><td>'.$newtab2['role'].'</td>                   <td class="d-flex"><form action="absences.php?edit='.$newtab2['id_as'].'" id="del3" method="post"><a title="Modifier" class="typcn typcn-edit  mdi-24px text-warning" id="dalf" data-id="'.$newtabx[$key]['id_as'].'"></a></form>                   <form action="#" id="del1" method="post"><a title="suprrimer" class="typcn typcn-delete mdi-24px text-danger" id="dell" data-id="'.$newtabx[$key]['id_as'].'"></a></form></td></tr>';}    }}echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er ,'dta' =>  (string) $dta ));}//mise a jour de clientif(isset($_POST["dtavs"])){    $obj = json_decode($_POST["dtavs"]);    $iduser=trim(strip_tags($obj->iduser));    $abs=trim(strip_tags($obj->abs));    $val=trim(strip_tags($obj->val));    $emp=trim(strip_tags($obj->emp));    $idabs=trim(strip_tags($obj->idabs));    $datedebut=trim(strip_tags($obj->datedebut));    $datefin=trim(strip_tags($obj->datefin));    $idfiche=trim(strip_tags($obj->idfiche));    if($er == '0'){        $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d H:i', strtotime($date));        $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d H:i', strtotime($date));       if($val == '1'){ $req1=$bdd->prepare("update absence set date1 =? ,date2 =?,idop =?,typeAbsence=?,fiche=?  where idabs= ?");           $req2=$bdd->prepare('select * from absence as a inner join users as b where a.idop = b.idCompte and a.idabs = ? group by a.idabs');}       else if($val == '2'){ $req1=$bdd->prepare("update astreinte set debutdate =? ,findate =?,idop_as =?,nature_as=?,afiche=?  where id_as= ?");           $req2=$bdd->prepare('select * from astreinte as a inner join users as b where a.idop_as = b.idCompte and a.id_as = ? group by a.id_as');}        $req1->execute(array($datedebut,$datefin,intval($emp),$abs,intval($idfiche),intval($idabs)));        $req2->execute(array(intval($idabs)));        $dta1 = $req2->fetchAll(\PDO::FETCH_ASSOC);        $newtabx= array(); foreach($dta1 as $key => $value) {            $newtabx[$key] = $value;            $newtab2 = array();            foreach ($newtabx[$key] as $key2 => $value2) {                $newtab2[$key2] = $value2;            }            if($val == '1'){$dta = '<th scope="row">'.$newtab2['idabs'].'</th><td scope="row">'.$newtab2['typeAbsence'].'</td><td scope="row">'.$newtab2['nomprenom'].'</td><td><b class="text-primary">de</b> '.date('Y-m-d H:i', strtotime($newtab2['date1'])).' <b class="text-primary">à</b>  '.date('Y-m-d H:i', strtotime($newtab2['date2'])).' </td><td>'.$newtab2['adresse'].'</td><td>'.$newtab2['email'].'</td><td>'.$newtab2['tel'].'</td><td>'.$newtab2['role'].'</td>                   <td><form action="absences.php?edit='.$newtab2['idabs'].'" id="del3" method="post"><a title="Modifier" class="typcn typcn-edit  mdi-24px text-warning" id="dalf" data-id="'.$newtabx[$key]['idabs'].'"></a></form>                   <form action="#" id="del1" method="post"><a title="supprimer" class="typcn typcn-delete mdi-24px text-danger" id="dell" data-id="'.$newtabx[$key]['idabs'].'"></a></form></td>';}            if($val == '2'){$dta = '<th scope="row">'.$newtab2['id_as'].'</th><td scope="row">'.$newtab2['nature_as'].'</td><td scope="row">'.$newtab2['nomprenom'].'</td><td><b class="text-primary">de</b> '.date('Y-m-d H:i', strtotime($newtab2['debutdate'])).' <b class="text-primary">à</b>  '.date('Y-m-d H:i', strtotime($newtab2['findate'])).' </td><td>'.$newtab2['adresse'].'</td><td>'.$newtab2['email'].'</td><td>'.$newtab2['tel'].'</td><td>'.$newtab2['role'].'</td>                   <td class="d-flex"><form action="absences.php?edit='.$newtab2['id_as'].'" id="del3" method="post"><a title="Modifier" class="typcn typcn-edit  mdi-24px text-warning" id="dalf" data-id="'.$newtabx[$key]['id_as'].'"></a></form>                   <form action="#" id="del1" method="post"><a title="suprrimer" class="typcn typcn-delete mdi-24px text-danger" id="dell" data-id="'.$newtabx[$key]['id_as'].'"></a></form></td>';}        }    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er,'dta' =>  (string)$dta  ));}////////ajouter un nouveau utilisateurif(isset($_POST["adatas"])) {    $obj = json_decode($_POST["adatas"]);    $iduser = trim(strip_tags($obj->iduser));    $nomprenom = trim(strip_tags($obj->nomprenom));    $adresse = trim(strip_tags($obj->adresse));    $email = trim(strip_tags($obj->email));    $tel = trim(strip_tags($obj->tel));    $rol = trim(strip_tags($obj->rol));    $pass = md5($obj->pass);    if ($er == '0') {        $req1 = $bdd->prepare('insert into users(nomPrenom,adresse,email,tel,role,pass) values(?,?,?,?,?,?)');        $req1->execute(array($nomprenom, $adresse, $email, $tel, $rol,$pass));    } ////    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er  ));}//mise a jour de l'utilisateurif(isset($_POST["adtavs"])){    $obj = json_decode($_POST["adtavs"]);    $idclient=trim(strip_tags($obj->idclient));    $iduser=trim(strip_tags($obj->iduser));    $nomprenom=trim(strip_tags($obj->nomprenom));    $adresse=trim(strip_tags($obj->adresse));    $email=trim(strip_tags($obj->email));    $tel=trim(strip_tags($obj->tel));    $rol=trim(strip_tags($obj->rol));    $pass=$obj->pass;    if($er == '0'){        if($pass =='' ){  $req1=$bdd->prepare("update users set nomprenom =? ,adresse =?,email =?,tel =?, role=?  where idCompte=? ");            $req1->execute(array($nomprenom,$adresse,$email,$tel,$rol,intval($idclient)));}       else {  $pass = md5($pass) ;$req1=$bdd->prepare("update users set nomprenom =? ,adresse =?,email =?,tel =?, role=?,pass=?  where idCompte=? ");            $req1->execute(array($nomprenom,$adresse,$email,$tel,$rol,$pass,intval($idclient)));}    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er  ));}////////ajouter interventionif(isset($_POST["dtas"])){    $obj = json_decode($_POST["dtas"]);    $identr = $_COOKIE['iduser'];    $fiche=trim(strip_tags($obj->idfiche));    $operateur=trim(strip_tags($obj->operateur));    $datedebut=trim(strip_tags($obj->datedebut));    $datefin=trim(strip_tags($obj->datefin));    $nature=trim(strip_tags($obj->nature));    if($nature == "" ){        $err .= '<p>* Veuillez ecrire la nature de votre intervention.</p><br />';        $er = '1';    }    $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d h:i', strtotime($date));    $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d h:i', strtotime($date));    $date1 = new DateTime($datedebut);$date2 = new DateTime($datefin);    $diff = $date1->diff($date2);$hours = $diff->i;    $hours = $hours / 60;    if(intval(date('d', strtotime($datedebut)))  > intval(date('d', strtotime($datefin))) ){        $err .= '<p>* Veuillez choisir la date de debut et la date de fin</p><br />';        $er = '1';    }    if($er == '0'){        $req1=$bdd->prepare('insert into intervention(fiche,nature,dateDebut,dateFin,duree,operateur) values(?,?,?,?,?,?)');        $req1->execute(array(intval($fiche),$nature,$datedebut,$datefin,$hours,intval($operateur)));    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er  ));}//mise a jour interventionif(isset($_POST["dtacs"])){    $obj = json_decode($_POST["dtacs"]);    $identr = $_COOKIE['iduser'];    $idinterv=trim(strip_tags($obj->idinterv));    $fiche=trim(strip_tags($obj->idfiche));    $operateur=trim(strip_tags($obj->operateur));    $datedebut=trim(strip_tags($obj->datedebut));    $datefin=trim(strip_tags($obj->datefin));    $duree=trim(strip_tags($obj->duree));    $nature=trim(strip_tags($obj->nature));    if($nature == "" ){        $err .= '<p>* Veuillez ecrire la nature de votre intervention.</p><br />';        $er = '1';    }    $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d h:i', strtotime($date));    $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d h:i', strtotime($date));    if(intval(date('h', strtotime($datedebut)))  > intval(date('h', strtotime($datefin))) ){        $err .= '<p>* Veuillez choisir la date et heure de debut et la date de fin</p><br />';        $er = '1';    }    if($er == '0'){$duree = 0;        $req1=$bdd->prepare("update intervention set fiche=?,nature=?,dateDebut=?,dateFin=?, duree=? where $sql3 and id = ?");        $req1->execute(array(intval($fiche),$nature,$datedebut,$datefin,$duree,intval($operateur),intval($idinterv)));    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er  ));}