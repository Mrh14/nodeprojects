<?phpinclude('config.php');$suc ='1';$er='0';$err='';$duree = 0;if($_COOKIE['usertype']=='admin' ){$sql= '9999 <> ?'; $sql2= '9999 <> ?';$sql3 ='9999 <> ?' ;}else{$sql= 'iduser = ?';$sql2= 'idCompte = ?';$sql3= 'operateur = ?';};//ajouter un nouveau clientif(isset($_POST["datas"])){$obj = json_decode($_POST["datas"]);    $iduser=trim(strip_tags($obj->iduser));    $nomprenom=trim(strip_tags($obj->nomprenom));    $adresse=trim(strip_tags($obj->adresse));    $email=trim(strip_tags($obj->email));    $tel=trim(strip_tags($obj->tel));    $siren=trim(strip_tags($obj->siren));    $rs=trim(strip_tags($obj->rs));if($er == '0'){    $req1=$bdd->prepare('insert into client(nomPrenom,adresse,email,tel,siren,rs,iduser) values(?,?,?,?,?,?,?)');    $req1->execute(array($nomprenom,$adresse,$email,$tel,$siren,$rs,intval($iduser)));    $id = $bdd->lastInsertId();    $req2=$bdd->prepare('select * from client where idclient=?');    $req2->execute(array(intval($id)));    $dta1 = $req2->fetchAll(\PDO::FETCH_ASSOC);    $newtabx= array(); foreach($dta1 as $key => $value) {        $newtabx[$key] = $value;        $newtab2 = array();        foreach ($newtabx[$key] as $key2 => $value2) {            $newtab2[$key2] = $value2;        }            if($_COOKIE['usertype']=='admin' ){$btn= '<form action="#" id="del1" method="post"><a title="supprimer" class="typcn typcn-delete mdi-24px text-danger"  id="dell" data-id="'.$newtabx[$key]['idclient'].'"></a></form>'; }else{$btn= '';};        $dta = '<th scope="row">'.$newtab2['idclient'].'</th><td>'.$newtab2['nomPrenom'].'</td><td>'.$newtab2['adresse'].'</td><td>'.$newtab2['email'].'</td><td>'.$newtab2['tel'].'</td><td>'.$newtab2['siren'].'</td><td>'            .$newtabx[$key]['rs'].            '</td><td class="d-flex"> <form action="reservations.php" id="del2" method="post"><a title="fiches de controles" class=" typcn typcn-th-list  mdi-24px text-primary" id="delf" data-id="'.$newtabx[$key]['idclient'].'"></a></form>                                                    <form action="reservations.php" id="del3" method="post"><a title="Ajouter" class="typcn typcn-document-add mdi-24px text-success" id="dalf" data-id="'.$newtabx[$key]['idclient'].'"></a></form>'.$btn.'</td>';    }}echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er ,'dta' =>  (string)$dta ));}//mise a jour de clientif(isset($_POST["dtavs"])){    $obj = json_decode($_POST["dtavs"]);    $idclient=trim(strip_tags($obj->idclient));    $iduser=trim(strip_tags($obj->iduser));    $nomprenom=trim(strip_tags($obj->nomprenom));    $adresse=trim(strip_tags($obj->adresse));    $email=trim(strip_tags($obj->email));    $tel=trim(strip_tags($obj->tel));    $siren=trim(strip_tags($obj->siren));    $rs=trim(strip_tags($obj->rs));    if($er == '0'){        $req1=$bdd->prepare("update client set nomPrenom =? ,adresse =?,email =?,tel =?, siren=?, rs=?  where $sql and idclient= ?");        $req1->execute(array($nomprenom,$adresse,$email,$tel,$siren,$rs,intval($iduser),intval($idclient)));        $req2=$bdd->prepare('select * from client where idclient=?');        $req2->execute(array(intval($idclient)));        $dta1 = $req2->fetchAll(\PDO::FETCH_ASSOC);        $newtabx= array(); foreach($dta1 as $key => $value) {            $newtabx[$key] = $value;            $newtab2 = array();            foreach ($newtabx[$key] as $key2 => $value2) {                $newtab2[$key2] = $value2;            }            if($_COOKIE['usertype']=='admin' ){$btn= '<form action="#" id="del1" method="post"><a title="supprimer" class="typcn typcn-delete mdi-24px text-danger"  id="dell" data-id="'.$newtabx[$key]['idclient'].'"></a></form>'; }else{$btn= '';};            $dta = '<th scope="row">'.$newtab2['idclient'].'</th><td>'.$newtab2['nomPrenom'].'</td><td>'.$newtab2['adresse'].'</td><td>'.$newtab2['email'].'</td><td>'.$newtab2['tel'].'</td><td>'.$newtab2['siren'].'</td><td>'                .$newtabx[$key]['rs'].                '</td><td class="d-flex"> <form action="reservations.php" id="del2" method="post"><a title="fiches de controles" class=" typcn typcn-th-list  mdi-24px text-primary" id="delf" data-id="'.$newtabx[$key]['idclient'].'"></a></form>                                                    <form action="reservations.php" id="del3" method="post"><a title="Ajouter" class="typcn typcn-document-add mdi-24px text-success" id="dalf" data-id="'.$newtabx[$key]['idclient'].'"></a></form>'.$btn.'</td>';        }    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er,'dta' =>  (string)$dta  ));}////////ajouter un nouveau utilisateurif(isset($_POST["adatas"])) {    $obj = json_decode($_POST["adatas"]);    $dta = '';    $iduser = trim(strip_tags($obj->iduser));    $nomprenom = trim(strip_tags($obj->nomprenom));    $email = trim(strip_tags($obj->email));    $rol = trim(strip_tags($obj->rol));    $pass = md5(trim(strip_tags($obj->pass)));    $permissions=trim(strip_tags($obj->permissions));    $req7 = $bdd->prepare('select * from users where email = ? ');    $req7->execute(array($email));    $nbs = $req7->rowCount();    $dta = '';    if(intval($nbs)!=0){        $err .= '<p>* l\'email entré existe dejà dans notre base de donnée</p><br />';        $er = '1';    }    if ($er == '0') {        $req1 = $bdd->prepare('insert into users(nomPrenom,email,role,pass,hisadmin) values(?,?,?,?,?)');        $req1->execute(array($nomprenom, $email, $rol,$pass,$_COOKIE['iduser']));        $idc = $bdd->lastInsertId();        $array = explode("/",$permissions);        for($i=0;$i<count($array);$i++){            if($array[$i]!='') {                $req1 = $bdd->prepare('insert into user_acl(iduser,idadmin,permission) values(?,?,?)');                $req1->execute(array(intval($idc), intval($_COOKIE['iduser']), $array[$i]));            }        }        //selectionner le dernie utilisateur inseré pour l'ajouter à notre datatable        $req2=$bdd->prepare('select * from users where idCompte = ?');        $req2->execute(array(intval($idc)));        $data = $req2->fetchAll(\PDO::FETCH_ASSOC);        $newtabx = array();        foreach ($data as $key => $value) {            $newtabx[$key] = $value;            $newtab2 = array();            foreach ($newtabx[$key] as $key2 => $value2) {                $newtab2[$key2] = $value2;            }            $dta =  ' <tr data-id="'.$newtab2['idCompte'].'"><th scope="row">'.$newtab2['idCompte'].'</th><td>'.$newtab2['nomprenom'].'</td><td>'.$newtab2['email'].'</td><td>'.$newtab2['role'].'</td>                     <td><form action="#" id="del1" method="post"><a title="supprimer" class="typcn typcn-delete mdi-24px text-danger"  id="dell" data-id="'.$newtabx[$key]['idCompte'].'"></a></form></td></tr>';        }    } ////    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er,'dta' => $dta ));}//mise a jour de l'utilisateurif(isset($_POST["adtavs"])){    $obj = json_decode($_POST["adtavs"]);    $idclient=trim(strip_tags($obj->idclient));    $iduser=trim(strip_tags($obj->iduser));    $nomprenom=trim(strip_tags($obj->nomprenom));    $email=trim(strip_tags($obj->email));    $rol=trim(strip_tags($obj->rol));    $pass=trim(strip_tags($obj->pass));    $permissions=trim(strip_tags($obj->permissions));    $array = explode("/",$permissions);    $req9 = $bdd->prepare('select * from users where idCompte = ? ');    $req9->execute(array(intval($idclient)));    while($ar2=$req9->fetch()){        $email2= $ar2['email'];    }    $dta = '';    if($email != $email2){    $req7 = $bdd->prepare('select * from users where email = ? ');    $req7->execute(array($email));    $nbs = $req7->rowCount();        if(intval($nbs)!=0){            $err .= '<p>* l\'email entré existe dejà dans notre base de donnée</p><br />';            $er = '1';        }    }    if($er == '0'){        if($pass =='' ){$req1=$bdd->prepare("update users set nomprenom =? ,email =?, role=?  where idCompte=? ");            $req1->execute(array($nomprenom,$email,$rol,intval($idclient)));}       else {$pass = md5($pass) ;$req1=$bdd->prepare("update users set nomprenom =? ,email =?, role=?,pass=?  where idCompte=? ");            $req1->execute(array($nomprenom,$email,$rol,$pass,intval($idclient)));}        $req1 = $bdd->prepare('delete from user_acl where iduser=?');        $req1->execute(array(intval($idclient)));        $array = explode("/",$permissions);        for($i=0;$i<count($array);$i++){            if($array[$i]!='') {                $req1 = $bdd->prepare('insert into user_acl(iduser,idadmin,permission) values(?,?,?)');                $req1->execute(array(intval($idclient), intval($_COOKIE['iduser']), $array[$i]));            }        }        //selectionner le dernier utilisateur modifié pour le mettre à jour dans le datatable        $req2=$bdd->prepare('select * from users where idCompte = ?');        $req2->execute(array(intval($idclient)));        $data = $req2->fetchAll(\PDO::FETCH_ASSOC);        $newtabx = array();        foreach ($data as $key => $value) {            $newtabx[$key] = $value;            $newtab2 = array();            foreach ($newtabx[$key] as $key2 => $value2) {                $newtab2[$key2] = $value2;            }            $dta =  ' <th scope="row">'.$newtab2['idCompte'].'</th><td>'.$newtab2['nomprenom'].'</td><td>'.$newtab2['email'].'</td><td>'.$newtab2['role'].'</td>                     <td><form action="#" id="del1" method="post"><a title="supprimer" class="typcn typcn-delete mdi-24px text-danger"  id="dell" data-id="'.$newtabx[$key]['idCompte'].'"></a></form></td>';        }    }    echo json_encode(array('val'=>$email2,'suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er,'dta' => $dta  ));}////////ajouter interventionif(isset($_POST["dtas"])){    $obj = json_decode($_POST["dtas"]);    $identr = $_COOKIE['iduser'];    $fiche=trim(strip_tags($obj->idfiche));    $operateur=trim(strip_tags($obj->operateur));    $datedebut=trim(strip_tags($obj->datedebut));    $datefin=trim(strip_tags($obj->datefin));    $nature=trim(strip_tags($obj->nature));    if($nature == "" ){        $err .= '<p>* Veuillez ecrire la nature de votre intervention.</p><br />';        $er = '1';    }    $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d h:i', strtotime($date));    $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d h:i', strtotime($date));    $date1 = new DateTime($datedebut);$date2 = new DateTime($datefin);    $diff = $date1->diff($date2);$hours = $diff->i;    $hours = $hours / 60;    if(intval(date('d', strtotime($datedebut)))  > intval(date('d', strtotime($datefin))) ){        $err .= '<p>* Veuillez choisir la date de debut et la date de fin</p><br />';        $er = '1';    }    if($er == '0'){        $req1=$bdd->prepare('insert into intervention(fiche,nature,dateDebut,dateFin,duree,operateur) values(?,?,?,?,?,?)');        $req1->execute(array(intval($fiche),$nature,$datedebut,$datefin,$hours,intval($operateur)));    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er  ));}//mise a jour interventionif(isset($_POST["dtacs"])){    $obj = json_decode($_POST["dtacs"]);    $identr = $_COOKIE['iduser'];    $idinterv=trim(strip_tags($obj->idinterv));    $fiche=trim(strip_tags($obj->idfiche));    $operateur=trim(strip_tags($obj->operateur));    $datedebut=trim(strip_tags($obj->datedebut));    $datefin=trim(strip_tags($obj->datefin));    $duree=trim(strip_tags($obj->duree));    $nature=trim(strip_tags($obj->nature));    if($nature == "" ){        $err .= '<p>* Veuillez ecrire la nature de votre intervention.</p><br />';        $er = '1';    }    $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d h:i', strtotime($date));    $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d h:i', strtotime($date));    if(intval(date('h', strtotime($datedebut)))  > intval(date('h', strtotime($datefin))) ){        $err .= '<p>* Veuillez choisir la date et heure de debut et la date de fin</p><br />';        $er = '1';    }    if($er == '0'){$duree = 0;        $req1=$bdd->prepare("update intervention set fiche=?,nature=?,dateDebut=?,dateFin=?, duree=? where $sql3 and id = ?");        $req1->execute(array(intval($fiche),$nature,$datedebut,$datefin,$duree,intval($operateur),intval($idinterv)));    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er  ));}