<?phpinclude('config.php');$suc ='1';$er='0';$err='';$df = '';if($_COOKIE['usertype']=='admin' ){$sql= '9999 <> ?'; $sql2= '9999 <> ?';$sql3= '9999 <> ?';}else{$sql= 'a.operateur = ?';$sql2= 'operateur = ?';$sql3= 'iduser = ?';};$nom = '';$denomination = '';$dta = ''; $data ='';function getInterventionNumber($val){    global $bdd;    $req3=$bdd->prepare('select * from intervention where fiche=?');    $req3->execute(array(intval($val)));    return $req3->rowcount();}//procedure trouver un clientif(isset($_POST['datas'])){    $obj = json_decode($_POST["datas"]);    $idclient=trim(strip_tags($obj->idclient));    $datedebut=trim(strip_tags($obj->datedebut));    $datefin=trim(strip_tags($obj->datefin));   if($idclient != ''){if($datedebut =='' and $datefin =='') { $req1=$bdd->prepare("select a.*,b.* from fichecontrole as a inner join client as b where a.client = b.idclient  and $sql and a.client=? group by b.idclient");$req1->execute(array(intval($_COOKIE['iduser']),intval($idclient)));}else if($datedebut !='' and $datefin !='') {    $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d', strtotime($date));    $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d', strtotime($date));        $req1=$bdd->prepare("select a.*,b.* from fichecontrole as a inner join client as b where a.client = b.idclient  and  b.iduser=? and $sql and a.client=? and a.datedebut <= ? and a.datefin >= ? group by b.idclient");        $req1->execute(array(intval($_COOKIE['iduser']),intval($_COOKIE['iduser']),intval($idclient),$datedebut,$datefin));}   }   else{       $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d', strtotime($date));       $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d', strtotime($date));       $req1=$bdd->prepare("select a.*,b.* from fichecontrole as a inner join client as b where a.client = b.idclient  and  $sql and a.datedebut <= ? and a.datefin >= ? ");       $req1->execute(array(intval($_COOKIE['iduser']),$datedebut,$datefin));   }    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    if (intval($row) == 0) {        $suc = '0';        $er = '1';        $dta .= '<tr><td colspan="6">Résultat de recherche est vide</td></tr>';    }    else{        $newtabx = array();        foreach ($data as $key => $value) {            $newtabx[$key] = $value;            $newtab2 = array();            foreach ($newtabx[$key] as $key2 => $value2) {                $newtab2[$key2] = $value2;            }            if($_COOKIE['usertype']=='admin' ){$btn= '<form action="#" id="del1" method="post"><a title="supprimer" class="typcn typcn-delete mdi-24px text-danger"  id="dell" data-id="'.$newtabx[$key]['idclient'].'"></a></form>'; }else{$btn= '';};            $dta .=  ' <tr data-id="'.$newtab2['idclient'].'" ><th scope="row">'.$newtab2['idclient'].'</th><td>'.$newtab2['nomPrenom'].'</td><td>'.$newtab2['adresse'].'</td><td>'.$newtab2['email'].'</td><td>'.$newtab2['tel'].'</td><td>'.$newtab2['siren'].'</td><td>'                .$newtabx[$key]['rs'].                '</td><td class="d-flex"> <form action="reservations.php" id="del2" method="post"><a title="fiches de controles" class=" typcn typcn-th-list  mdi-24px text-primary" id="delf" data-id="'.$newtabx[$key]['idclient'].'"></a></form>                                                    <form action="reservations.php" id="del3" method="post"><a title="Ajouter" class="typcn typcn-document-add mdi-24px text-success" id="dalf" data-id="'.$newtabx[$key]['idclient'].'"></a></form>'.$btn.'</td></tr>';        }    }echo json_encode(array(    'suc' =>  (string)$suc, 'err' =>  (string)$err , 'er' =>  (string)$er , 'dta' => $dta));}//trouver les absencesif(isset($_POST['dtasc'])){    $obj = json_decode($_POST["dtasc"]);    $idemp=trim(strip_tags($obj->idemp));    $val=trim(strip_tags($obj->val));    $datedebut=trim(strip_tags($obj->datedebut));    $datefin=trim(strip_tags($obj->datefin));    if($idemp != ''){        if($datedebut =='' and $datefin =='') {            if($val == '1'){$req1=$bdd->prepare("select * from absence as a inner join users as b where a.idop = b.idCompte and a.idop = ? group by a.idabs");}           else if($val == '2'){$req1=$bdd->prepare("select * from astreinte as a inner join users as b where a.idop_as = b.idCompte and a.idop_as = ? group by a.id_as");}            $req1->execute(array(intval($idemp)));        }        else if($datedebut !='' and $datefin !='') {$date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d', strtotime($date));            $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d', strtotime($date));            if($val == '1'){$req1=$bdd->prepare("select * from absence as a inner join users as b where a.idop = b.idCompte and a.idop = ? and (a.date2 >= ? or (a.date2 >= ?) ) group by a.idabs");}            else if($val == '2'){$req1=$bdd->prepare("select * from astreinte as a inner join users as b where a.idop_as = b.idCompte and a.idop_as = ? and (a.findate >= ? or (a.findate >= ?) ) group by a.id_as");}            $req1->execute(array(intval($idemp),$datefin,$datedebut));}    }    else{        $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d', strtotime($date));        $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d', strtotime($date));        if($val == '1'){ $req1=$bdd->prepare("select * from absence as a inner join users as b where a.idop = b.idCompte  and (a.date2 >= ? or (a.date2 >= ?)) ");}        else if($val == '2'){ $req1=$bdd->prepare("select * from astreinte as a inner join users as b where a.idop_as = b.idCompte  and (a.findate >= ? or (a.findate >= ?)) ");}        $req1->execute(array($datefin,$datedebut));    }    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    if (intval($row) == 0) {        $suc = '0';        $er = '1';        $dta .= '<tr><td colspan="9">Résultat de recherche est vide</td></tr>';    }    else{        $newtabx = array();        foreach ($data as $key => $value) {            $newtabx[$key] = $value;            $newtab2 = array();            foreach ($newtabx[$key] as $key2 => $value2) {                $newtab2[$key2] = $value2;            }            if($val == '1'){$dta .=  '<tr data-id="'.$newtab2['idabs'].'"><th scope="row">'.$newtab2['idabs'].'</th><td scope="row">'.$newtab2['typeAbsence'].'</td><td scope="row">'.$newtab2['nomprenom'].'</td><td><b class="text-primary">de</b> '.date('Y-m-d', strtotime($newtab2['date1'])).' <b class="text-primary">à</b>  '.date('Y-m-d', strtotime($newtab2['date2'])).' </td><td>'.$newtab2['adresse'].'</td><td>'.$newtab2['email'].'</td><td>'.$newtab2['tel'].'</td><td>'.$newtab2['role'].'</td>                   <td class="d-flex"><form action="absences.php?edit='.$newtab2['idabs'].'" id="del3" method="post"><a title="Modifier" class="typcn typcn-edit  mdi-24px text-warning" id="dalf" data-id="'.$newtabx[$key]['idabs'].'"></a></form>                   <form action="#" id="del1" method="post"><a title="suprrimer" class="typcn typcn-delete mdi-24px text-danger" id="dell" data-id="'.$newtabx[$key]['idabs'].'"></a></form></td></tr>';}            if($val == '2'){$dta .=  '<tr data-id="'.$newtab2['id_as'].'"><th scope="row">'.$newtab2['id_as'].'</th><td scope="row">'.$newtab2['nature_as'].'</td><td scope="row">'.$newtab2['nomprenom'].'</td><td><b class="text-primary">de</b> '.date('Y-m-d', strtotime($newtab2['debutdate'])).' <b class="text-primary">à</b>  '.date('Y-m-d', strtotime($newtab2['findate'])).' </td><td>'.$newtab2['adresse'].'</td><td>'.$newtab2['email'].'</td><td>'.$newtab2['tel'].'</td><td>'.$newtab2['role'].'</td>                   <td class="d-flex"><form action="absences.php?edit='.$newtab2['id_as'].'" id="del3" method="post"><a title="Modifier" class="typcn typcn-edit  mdi-24px text-warning" id="dalf" data-id="'.$newtabx[$key]['id_as'].'"></a></form>                   <form action="#" id="del1" method="post"><a title="suprrimer" class="typcn typcn-delete mdi-24px text-danger" id="dell" data-id="'.$newtabx[$key]['id_as'].'"></a></form></td></tr>';}        }    }    echo json_encode(array(        'suc' =>  (string)$suc, 'err' =>  (string)$err , 'er' =>  (string)$er , 'dta'      =>  $dta    ));}/////////////////////// procedure trouver liste utilisateurif(isset($_POST['adatas'])){    $obj = json_decode($_POST["adatas"]);    $idclient=trim(strip_tags($obj->idclient));    $rol=trim(strip_tags($obj->rol));    if($rol != ''){        if($idclient =='') { $req1=$bdd->prepare('select * from users where role=? and hisadmin=? ');            $req1->execute(array($rol,$_COOKIE['iduser']));}        else {            $req1=$bdd->prepare('select * from users where role=? and idCompte = ?');            $req1->execute(array($rol,intval($idclient)));}    }    else{        $req1=$bdd->prepare('select * from users ');        $req1->execute();    }    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    if (intval($row) == 0) {$suc = '0';$er = '1';$dta .= '<tr><td colspan="6">Résultat de recherche est vide</td></tr>';}    else{$newtabx = array();        foreach ($data as $key => $value) {            $newtabx[$key] = $value;            $newtab2 = array();            foreach ($newtabx[$key] as $key2 => $value2) {                $newtab2[$key2] = $value2;            }            $dta .=  ' <tr data-id="'.$newtab2['idCompte'].'"><th scope="row">'.$newtab2['idCompte'].'</th><td>'.$newtab2['nomprenom'].'</td><td>'.$newtab2['email'].'</td><td>'.$newtab2['role'].'</td>                     <td><form action="#" id="del1" method="post"><a title="supprimer" class="typcn typcn-delete mdi-24px text-danger"  id="dell" data-id="'.$newtabx[$key]['idCompte'].'"></a></form></td></tr>';        }    }    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'dta'      =>  $dta    ));}//formulaire pour supprimer un utilisateurif(isset($_POST['adatc'])){    $obj = json_decode($_POST["adatc"]);    $idcompte=trim(strip_tags($obj->idcompte));    $req1=$bdd->prepare('delete from users where idCompte=?');    $req1->execute(array(intval($idcompte)));    // supprimer aussi les intervention de cette fiche control    $req1=$bdd->prepare('select *  from users where idCompte=?');    $req1->execute(array(intval($idcompte)));    $row = $req1->rowCount();    if($row == '0'){$suc = 1;$er = 0;} else{ $suc = 0;$er = 1;$err= 'l\'utilisateur n\'pas été supprimé veuiller recharger la page et réssayer';}    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'cnt'      =>  $row    ));}//formulaire pour supprimer un clientif(isset($_POST['datc'])){    $obj = json_decode($_POST["datc"]);    $idfiche=trim(strip_tags($obj->idfiche));    $req1=$bdd->prepare('delete from client where idclient=?');    $req1->execute(array(intval($idfiche)));    // supprimer aussi les intervention de cette fiche control    $req1=$bdd->prepare('select *  from client where idclient=?');    $req1->execute(array(intval($idfiche)));    $row = $req1->rowCount();    if($row == '0'){$suc = 1;$er = 0;} else{ $suc = 0;$er = 1;$err= 'l\'utilisateur n\'pas été supprimé veuiller recharger la page et réssayer';}    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'cnt'      =>  $row    ));}//formulaire pour supprimer une absenceif(isset($_POST['datx'])){    $obj = json_decode($_POST["datx"]);    $idabs=trim(strip_tags($obj->idabs));    $req1=$bdd->prepare('delete from absence where idabs=?');    $req1->execute(array(intval($idabs)));    // supprimer aussi les intervention de cette fiche control    $req1=$bdd->prepare('select *  from absence where idabs=?');    $req1->execute(array(intval($idabs)));    $row = $req1->rowCount();    if($row == '0'){$suc = 1;$er = 0;} else{ $suc = 0;$er = 1;$err= 'l\'absence n\'pas été supprimé veuiller recharger la page et réssayer';}    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'cnt'      =>  $row    ));}//formulaire pour supprimer une interventionif(isset($_POST['datav'])){    $obj = json_decode($_POST["datav"]);    $idinter=trim(strip_tags($obj->idinter));    $req1=$bdd->prepare('delete  from intervention where id=?');    $req1->execute(array(intval($idinter)));    $req1=$bdd->prepare('select *  from intervention where id=?');    $req1->execute(array(intval($idinter)));    $row = $req1->rowCount();  if($row == '0'){$suc = 1;$er = 0;} else{ $suc = 0;$er = 1;$err= 'l\'intervention n\'pas été supprimé veuiller recharger la page et réssayer';}    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'cnt'      =>  $row    ));}if(isset($_POST['datavs'])){    $obj = json_decode($_POST["datavs"]);    $idclient=trim(strip_tags($obj->idclient));    $datedebut=trim(strip_tags($obj->datedebut));    $datefin=trim(strip_tags($obj->datefin));    if($idclient != ''){        if($datedebut =='' and $datefin =='') {            $req1=$bdd->prepare("select a.*,b.*, c.* from intervention as a inner join fichecontrole as b on a.fiche = b.idfiche inner join client as c on b.client = c.idclient  and $sql and c.idclient =? group by a.id ");            $req1->execute(array(intval($_COOKIE['iduser']),intval($idclient)));        }        else if($datedebut !='' and $datefin !='') {            $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d H:i:s', strtotime($date));            $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d H:i:s', strtotime($date));            $req1=$bdd->prepare("select a.*,b.*, c.* from intervention as a inner join fichecontrole as b on a.fiche = b.idfiche inner join client as c on b.client = c.idclient   and $sql and c.idclient =? and a.dateDebut >= ? and a.dateFin <= ? ");            $req1->execute(array(intval($_COOKIE['iduser']),intval($idclient),$datedebut,$datefin));        }    }    else{    }    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    if (intval($row) == 0) {        $suc = '0';        $er = '1';        $dta = '<tr><td colspann="7">Résultat de recherche est vide</td></tr>';    }    else{        $newtabx = array();        foreach ($data as $key => $value) {            $newtabx[$key] = $value;            $newtab2 = array();            foreach ($newtabx[$key] as $key2 => $value2) {                $newtab2[$key2] = $value2;            }            $date1 = new DateTime($newtab2['dateDebut']);$date2 = new DateTime($newtab2['dateFin']);            $diff = $date1->diff($date2);$hours = $diff->i;            $hours = $hours / 60;            $dta .=     ' <tr data-id="'.$newtab2['idfiche'].'"><th scope="row">'.$newtab2['id'].'</th><td>'.$newtab2['idfiche'].'</td><td>'.$newtab2['dateDebut'].'</td><td>'.$newtab2['dateFin'].'</td><td>'.number_format($hours,2).' H</td><td>'                                                    .$newtabx[$key]['nomPrenom'].                                                  '</td><td>' .$newtabx[$key]['nature'].'</td><td><form action="#" id="del1" method="post"><button type="submit" class="btn btn-danger btn-sm" id="'.$newtabx[$key]['id'].'">supprimer</button></form></td></tr>';        }    }    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'dta'      =>  $dta    ));}// remplir modification client form apres liste selectif(isset($_POST['dtas'])){    $obj = json_decode($_POST["dtas"]);    $idclient=trim(strip_tags($obj->idclient));    $req1=$bdd->prepare("select * from client where idclient =? and $sql3");    $req1->execute(array(intval($idclient),intval($_COOKIE['iduser'])));    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'dta'      =>  $data    ));}// remplir modification utilisateurs form apres liste selectif(isset($_POST['adtas'])){    $obj = json_decode($_POST["adtas"]);    $idclient=trim(strip_tags($obj->idclient));    $req1=$bdd->prepare('select * from users where idCompte =?');    $req1->execute(array(intval($idclient)));    $req2=$bdd->prepare('select * from user_acl where iduser =?');    $req2->execute(array(intval($idclient)));    $array = array();    while($ar=$req2->fetch()){        array_push( $array,$ar['permission']);    }    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'dta'      =>  $data,        'permissions' => $array    ));} ////// remplir utilisateurs list form apres liste rol select onglet rechercheif(isset($_POST['adats'])){    $obj = json_decode($_POST["adats"]);    $rol=trim(strip_tags($obj->rol));    $req1=$bdd->prepare('select * from users where role =? and hisadmin=?');    $req1->execute(array($rol,$_COOKIE['iduser']));    $row = $req1->rowcount();    while($ar=$req1->fetch()){ $data .= '<option value="'.$ar['idCompte'].'">'.$ar['nomprenom'].'</option>';    }    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'dta'      =>  $data    ));} ////if(isset($_POST['dtavs'])){    $obj = json_decode($_POST["dtavs"]);    $idinterv=trim(strip_tags($obj->idinterv));    $req1=$bdd->prepare("select * from intervention where id =? and $sql2");    $req1->execute(array(intval($idinterv),intval($_COOKIE['iduser'])));    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'dta'      =>  $data    ));}// afficher une fiche clientif(isset($_POST['ficheclient'])){    $obj = json_decode($_POST["ficheclient"]);    $idclient=trim(strip_tags($obj->idclient));    $data ='';    $req2=$bdd->prepare('select * from users where idCompte =?');    $req2->execute(array(intval($idclient)));    $row = $req2->rowcount();    if(intval($row)==0){        $er = 1;        $err = 'Ce Client n\'existe pas dans la base de données';    }    if($row !=0){        $dta = $req2->fetchAll(PDO::FETCH_ASSOC);      //  $data = $dta[0]['email'];        $data .= ' <label class="col-sm-4 col-form-label">Photo de Profil</label>                        <div class="col-sm-8 mb-1">                              <img style="width:200px;height:200px;" src="'.$url.'assets/upload/'.$dta[0]['profil'].'" alt="" />                        </div>';        $data .= ' <label class="col-sm-4 col-form-label">Nom complet</label>                        <div class="col-sm-8 mb-1">                              <b>'.$dta[0]['nomprenom'].' '.$dta[0]['prenom'].'</b>                        </div>';        $data .= ' <label class="col-sm-4 col-form-label">Taille</label>                        <div class="col-sm-8 mb-1">                              <b>'.$dta[0]['taille'].' Centimétres</b>                        </div>';        $data .= ' <label class="col-sm-4 col-form-label">Poid</label>                        <div class="col-sm-8 mb-1">                              <b>'.$dta[0]['poid'].' kg</b>                        </div>';        $data .= ' <label class="col-sm-4 col-form-label">Sexe</label>                        <div class="col-sm-8 mb-1">                              <b>'.$dta[0]['sexe'].'</b>                        </div>';        $data .= ' <label class="col-sm-4 col-form-label">Email</label>                        <div class="col-sm-8 mb-1">                            <b>'.$dta[0]['email'].'</b>                        </div>';        $data .= ' <label class="col-sm-4 col-form-label">Téléphone</label>                        <div class="col-sm-8 mb-1">                            <b>'.$dta[0]['tel'].'</b>                        </div>';        $data .= ' <label class="col-sm-4 col-form-label">Date de Naissance</label>                        <div class="col-sm-8 mb-1">                            <b>'.$dta[0]['naissance'].'</b>                        </div>';        $data .= ' <label class="col-sm-4 col-form-label">Niveau Du coach souhaité</label>                        <div class="col-sm-8 mb-1">                            <b>'.$dta[0]['niveauCoach'].'</b>                        </div>';    }    echo json_encode(array(        'suc' =>  (string)$suc, 'err' =>  (string)$err , 'er' =>  (string)$er , 'dta'      =>  $data    ));} ////