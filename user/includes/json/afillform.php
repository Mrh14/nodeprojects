<?phpinclude('config.php');$suc ='1';$er='0';$err='';$df = '';if($_COOKIE['usertype']=='admin' ){$sql= '9999 <> ?'; $sql2= '9999 <> ?';$sql3= '9999 <> ?';}else{$sql= 'a.operateur = ?';$sql2= 'operateur = ?';$sql3= 'iduser = ?';};$nom = '';$denomination = '';$dta = ''; $data ='';function getInterventionNumber($val){    global $bdd;    $req3=$bdd->prepare('select * from intervention where fiche=?');    $req3->execute(array(intval($val)));    return $req3->rowcount();}//procedure trouver un clientif(isset($_POST['datas'])){    $obj = json_decode($_POST["datas"]);    $idclient=trim(strip_tags($obj->idclient));    $datedebut=trim(strip_tags($obj->datedebut));    $datefin=trim(strip_tags($obj->datefin));   if($idclient != ''){if($datedebut =='' and $datefin =='') { $req1=$bdd->prepare("select a.*,b.* from fichecontrole as a inner join client as b where a.client = b.idclient  and $sql and a.client=? group by b.idclient");$req1->execute(array(intval($_COOKIE['iduser']),intval($idclient)));}else if($datedebut !='' and $datefin !='') {    $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d', strtotime($date));    $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d', strtotime($date));        $req1=$bdd->prepare("select a.*,b.* from fichecontrole as a inner join client as b where a.client = b.idclient  and  b.iduser=? and $sql and a.client=? and a.datedebut <= ? and a.datefin >= ? group by b.idclient");        $req1->execute(array(intval($_COOKIE['iduser']),intval($_COOKIE['iduser']),intval($idclient),$datedebut,$datefin));}   }   else{       $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d', strtotime($date));       $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d', strtotime($date));       $req1=$bdd->prepare("select a.*,b.* from fichecontrole as a inner join client as b where a.client = b.idclient  and  $sql and a.datedebut <= ? and a.datefin >= ? ");       $req1->execute(array(intval($_COOKIE['iduser']),$datedebut,$datefin));   }    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    if (intval($row) == 0) {        $suc = '0';        $er = '1';        $dta .= '<tr><td colspan="6">Résultat de recherche est vide</td></tr>';    }    else{        $newtabx = array();        foreach ($data as $key => $value) {            $newtabx[$key] = $value;            $newtab2 = array();            foreach ($newtabx[$key] as $key2 => $value2) {                $newtab2[$key2] = $value2;            }            if($_COOKIE['usertype']=='admin' ){$btn= '<form action="#" id="del1" method="post"><button type="button" class="btn btn-danger btn-sm" id="dell" data-id="'.$newtabx[$key]['idclient'].'">supprimer</button></form>'; }else{$btn= '';};            $dta .=  ' <tr data-id="'.$newtab2['idclient'].'" ><th scope="row">'.$newtab2['idclient'].'</th><td>'.$newtab2['nomPrenom'].'</td><td>'.$newtab2['adresse'].'</td><td>'.$newtab2['email'].'</td><td>'.$newtab2['tel'].'</td><td>'.$newtab2['siren'].'</td><td>'                .$newtabx[$key]['rs'].                '</td><td>'.$btn.' <form action="reservations.php" id="del2" method="post"><button type="button" class="btn btn-primary btn-sm" id="delf" data-id="'.$newtabx[$key]['idclient'].'">fiches de controle</button></form>                                                    <form action="reservations.php" id="del3" method="post"><button type="button" class="btn btn-success btn-sm" id="dalf" data-id="'.$newtabx[$key]['idclient'].'">Ajouter</button></form></td></tr>';        }    }echo json_encode(array(    'suc' =>  (string)$suc,    'err' =>  (string)$err ,    'er' =>  (string)$er ,    'dta'      =>  $dta));}/////////////////////// procedure trouver liste utilisateurif(isset($_POST['adatas'])){    $obj = json_decode($_POST["adatas"]);    $idclient=trim(strip_tags($obj->idclient));    $rol=trim(strip_tags($obj->rol));    if($rol != ''){        if($idclient =='') { $req1=$bdd->prepare('select * from users where role=? ');            $req1->execute(array($rol));}        else {            $req1=$bdd->prepare('select * from users where role=? and idCompte = ?');            $req1->execute(array($rol,intval($idclient)));}    }    else{        $req1=$bdd->prepare('select * from users ');        $req1->execute();    }    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    if (intval($row) == 0) {$suc = '0';$er = '1';$dta .= '<tr><td colspan="6">Résultat de recherche est vide</td></tr>';}    else{$newtabx = array();        foreach ($data as $key => $value) {            $newtabx[$key] = $value;            $newtab2 = array();            foreach ($newtabx[$key] as $key2 => $value2) {                $newtab2[$key2] = $value2;            }            $dta .=  ' <tr><th scope="row">'.$newtab2['idCompte'].'</th><td>'.$newtab2['nomprenom'].'</td><td>'.$newtab2['adresse'].'</td><td>'.$newtab2['email'].'</td><td>'.$newtab2['tel'].'</td><td>'.$newtab2['role'].'</td>                     <td><form action="#" id="del1" method="post"><button type="button" class="btn btn-danger btn-sm" id="dell" data-id="'.$newtabx[$key]['idCompte'].'">supprimer</button></form></td></tr>';        }    }    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'dta'      =>  $dta    ));}//formulaire pour supprimer un utilisateurif(isset($_POST['adatc'])){    $obj = json_decode($_POST["adatc"]);    $idcompte=trim(strip_tags($obj->idcompte));    $req1=$bdd->prepare('delete from users where idCompte=?');    $req1->execute(array(intval($idcompte)));    // supprimer aussi les intervention de cette fiche control    $req1=$bdd->prepare('select *  from users where idCompte=?');    $req1->execute(array(intval($idcompte)));    $row = $req1->rowCount();    if($row == '0'){$suc = 1;$er = 0;} else{ $suc = 0;$er = 1;$err= 'l\'utilisateur n\'pas été supprimé veuiller recharger la page et réssayer';}    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'cnt'      =>  $row    ));}//formulaire pour supprimer un clientif(isset($_POST['datc'])){    $obj = json_decode($_POST["datc"]);    $idfiche=trim(strip_tags($obj->idfiche));    $req1=$bdd->prepare('delete from client where idclient=?');    $req1->execute(array(intval($idfiche)));    // supprimer aussi les intervention de cette fiche control    $req1=$bdd->prepare('select *  from client where idclient=?');    $req1->execute(array(intval($idfiche)));    $row = $req1->rowCount();    if($row == '0'){$suc = 1;$er = 0;} else{ $suc = 0;$er = 1;$err= 'l\'utilisateur n\'pas été supprimé veuiller recharger la page et réssayer';}    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'cnt'      =>  $row    ));}//formulaire pour supprimer une interventionif(isset($_POST['datav'])){    $obj = json_decode($_POST["datav"]);    $idinter=trim(strip_tags($obj->idinter));    $req1=$bdd->prepare('delete  from intervention where id=?');    $req1->execute(array(intval($idinter)));    $req1=$bdd->prepare('select *  from intervention where id=?');    $req1->execute(array(intval($idinter)));    $row = $req1->rowCount();  if($row == '0'){$suc = 1;$er = 0;} else{ $suc = 0;$er = 1;$err= 'l\'intervention n\'pas été supprimé veuiller recharger la page et réssayer';}    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'cnt'      =>  $row    ));}if(isset($_POST['datavs'])){    $obj = json_decode($_POST["datavs"]);    $idclient=trim(strip_tags($obj->idclient));    $datedebut=trim(strip_tags($obj->datedebut));    $datefin=trim(strip_tags($obj->datefin));    if($idclient != ''){        if($datedebut =='' and $datefin =='') {            $req1=$bdd->prepare("select a.*,b.*, c.* from intervention as a inner join fichecontrole as b on a.fiche = b.idfiche inner join client as c on b.client = c.idclient  and $sql and c.idclient =? group by a.id ");            $req1->execute(array(intval($_COOKIE['iduser']),intval($idclient)));        }        else if($datedebut !='' and $datefin !='') {            $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d H:i:s', strtotime($date));            $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d H:i:s', strtotime($date));            $req1=$bdd->prepare("select a.*,b.*, c.* from intervention as a inner join fichecontrole as b on a.fiche = b.idfiche inner join client as c on b.client = c.idclient   and $sql and c.idclient =? and a.dateDebut >= ? and a.dateFin <= ? ");            $req1->execute(array(intval($_COOKIE['iduser']),intval($idclient),$datedebut,$datefin));        }    }    else{    }    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    if (intval($row) == 0) {        $suc = '0';        $er = '1';        $dta = '<tr><td colspann="7">Résultat de recherche est vide</td></tr>';    }    else{        $newtabx = array();        foreach ($data as $key => $value) {            $newtabx[$key] = $value;            $newtab2 = array();            foreach ($newtabx[$key] as $key2 => $value2) {                $newtab2[$key2] = $value2;            }            $date1 = new DateTime($newtab2['dateDebut']);$date2 = new DateTime($newtab2['dateFin']);            $diff = $date1->diff($date2);$hours = $diff->i;            $hours = $hours / 60;            $dta .=     ' <tr data-id="'.$newtab2['idfiche'].'"><th scope="row">'.$newtab2['id'].'</th><td>'.$newtab2['idfiche'].'</td><td>'.$newtabx[$key]['nomPrenom'].'</td><td>'.$newtab2['dateDebut'].'</td><td>'.$newtab2['dateFin'].'</td><td>'.number_format($hours,2).' H</td><td>                                                                                                      <td>' .$newtabx[$key]['nature'].'</td><td><form action="#" id="del1" method="post"><button type="submit" class="btn btn-danger btn-sm" id="'.$newtabx[$key]['id'].'">supprimer</button></form></td></tr>';        }    }    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'dta'      =>  $dta    ));}// remplir modification client form apres liste selectif(isset($_POST['dtas'])){    $obj = json_decode($_POST["dtas"]);    $idabs=trim(strip_tags($obj->idabs));    $val =trim(strip_tags($obj->val));    $dta2 = '<option value="">choisir la fiche</option>';$newtabx = array();$idemp='';    if($val == '1'){$req1=$bdd->prepare('select a.*, b.* from absence as a inner join users as b where a.idop = b.idCompte and a.idabs = ? group by a.idabs');}    else if($val == '2'){$req1=$bdd->prepare('select a.*, b.* from astreinte as a inner join users as b where a.idop_as = b.idCompte and a.id_as = ? group by a.id_as');}    $req1->execute(array(intval($idabs)));    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    foreach ($data as $key => $value) {$newtabx[$key] = $value;$newtab2 = array();        foreach ($newtabx[$key] as $key2 => $value2) { $newtab2[$key2] = $value2; }        if($val == '1'){$idemp = $newtab2['idop'];$fiche = $newtab2['fiche'];}       else if($val == '2'){$idemp = $newtab2['idop_as'];$fiche = $newtab2['afiche'];}    }    //procedure pour retourner aussi la liste la fiche de controle de cet employé    $newtabx = array();    $req1=$bdd->prepare("select a.*,b.* from fichecontrole as a inner join users as b on a.operateur = b.idCompte where a.operateur =? group by a.idfiche");    $req1->execute(array(intval($idemp)));    $row = $req1->rowcount();    $data2 = $req1->fetchAll(PDO::FETCH_ASSOC);    foreach ($data2 as $key => $value) {$newtabx[$key] = $value;$newtab2 = array();        foreach ($newtabx[$key] as $key2 => $value2) { $newtab2[$key2] = $value2; }        $sel = ''; if($fiche == $newtab2['idfiche']){$sel="selected";}        $dta2 .=   ' <option value="'.$newtab2['idfiche'] .'" '.$sel.' >'.$newtab2['nomprenom'] .' N° de fiche '.$newtab2['idfiche'] .' </option>' ;    }    echo json_encode(array('suc' =>  (string)$suc, 'err' =>  (string)$err , 'er' =>  (string)$er , 'dta' =>  $data,'dta2'  =>  $dta2 ));}// remplir modification utilisateurs form apres liste selectif(isset($_POST['adtas'])){    $obj = json_decode($_POST["adtas"]);    $idclient=trim(strip_tags($obj->idclient));    $req1=$bdd->prepare('select * from users where idCompte =?');    $req1->execute(array(intval($idclient)));    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'dta'      =>  $data    ));} ////// remplir utilisateurs list form apres liste rol select onglet rechercheif(isset($_POST['adats'])){    $obj = json_decode($_POST["adats"]);    $rol=trim(strip_tags($obj->rol));    $req1=$bdd->prepare('select * from users where role =?');    $req1->execute(array($rol));    $row = $req1->rowcount();    while($ar=$req1->fetch()){ $data .= '<option value="'.$ar['idCompte'].'">'.$ar['nomprenom'].'</option>';    }    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'dta'      =>  $data    ));} ////if(isset($_POST['dtavs'])){    $obj = json_decode($_POST["dtavs"]);    $idinterv=trim(strip_tags($obj->idinterv));    $req1=$bdd->prepare("select * from intervention where id =? and $sql2");    $req1->execute(array(intval($idinterv),intval($_COOKIE['iduser'])));    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'dta'      =>  $data    ));}