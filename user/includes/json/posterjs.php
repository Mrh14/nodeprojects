<?phpinclude('config.php');$suc ='1';$er='0';$err='';$id ='';//ajouter une dispionibiitéif(isset($_POST["fichecreate"])){    $obj = json_decode($_POST["fichecreate"]);    $iduser = $_COOKIE['iduser'];    if($_COOKIE['usertype']=='user'){        $req2=$bdd->prepare('select * from user_acl where iduser =?');        $req2->execute(array(intval($_COOKIE['iduser'])));        while($ar2 = $req2->fetch()){$iduser = $ar2['idadmin'];}    }    $datedebut=trim(strip_tags($obj->datedebut));    $datefin=trim(strip_tags($obj->datefin));    $nature=trim(strip_tags($obj->nature));    if($nature == "" ){        $err .= '<p>* Veuillez ecrire le titre de votre Conférence.</p><br />';$er = '1';    }    $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d H:i:s', strtotime($date));    $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d H:i:s', strtotime($date));    $datet1 = strtotime($datedebut);    $datet2 = strtotime($datefin);    $hours = round(floatval(($datet2 - $datet1) / 3600),2)   ;    if((date('i', strtotime($datedebut)) == '00' or date('i', strtotime($datedebut)) =='30') and ( date('i', strtotime($datefin)) =='00' or date('i', strtotime($datefin)) =='30' )){    }else{        $err .= '* Les minutes doivent être explicitement 00 ou 30';$er = '1';    }    if(intval(strtotime($datedebut))  > intval(strtotime($datefin)) or ((strtotime($datefin)) - intval(strtotime($datedebut)) ==0 ) ){        $err .= '* Veuillez choisir l\'heure de debut et l\'heure de fin';        $er = '1';    }    if($er == '0'){        $req1=$bdd->prepare('insert into rendezvous(titre,dateStart,dateEnd,idEmetteur) values(?,?,?,?)');        $req1->execute(array($nature,$datedebut,$datefin,$iduser));        $id = $bdd->lastInsertId();            }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er,'dta' =>  $id  ));}//ajouter un packif(isset($_POST["pack"]) and ($_COOKIE['usertype']=='admin' or $_COOKIE['usertype']=='user' )){    $obj = json_decode($_POST["pack"]);    $iduser = $_COOKIE['iduser'];    if($_COOKIE['usertype']=='user'){        $req2=$bdd->prepare('select * from user_acl where iduser =?');        $req2->execute(array(intval($_COOKIE['iduser'])));        while($ar2 = $req2->fetch()){$iduser = $ar2['idadmin'];}    }    $packname=trim(strip_tags($obj->packname));    $nbvisio=trim(strip_tags($obj->nbvisio));    $hrvisio=trim(strip_tags($obj->hrvisio));    $nbpublic=trim(strip_tags($obj->nbpublic));    $hrpublic=trim(strip_tags($obj->hrpublic));    $nbdomicile=trim(strip_tags($obj->nbdomicile));    $hrdomicile=trim(strip_tags($obj->hrdomicile));    $nbJours=trim(strip_tags($obj->nbJours));    $nbMois=trim(strip_tags($obj->nbMois));    $premierRdv=trim(strip_tags($obj->premierRdv));    $deuxiemeRdv=trim(strip_tags($obj->deuxiemeRdv));    $prvisio=trim(strip_tags($obj->prvisio));    $prpublic=trim(strip_tags($obj->prpublic));    $prdomicile=trim(strip_tags($obj->prdomicile));    $amount=trim(strip_tags($obj->amount));    $image=trim(strip_tags($obj->image));    $extras=$obj->extras;    if($packname == "" ){        $err .= '<p>* Veuillez ecrire Le nom de pack.</p><br />';$er = '1';    }    if($nbMois == '0' and $nbJours == '0'  ){        $err .= '<p>* Veuillez Choisir la durée en jours ou mois ou les deux.</p><br />';$er = '1';    }    if($er == '0'){        $req1=$bdd->prepare('insert into packs(amount,picture,packname,nbvisio,hrvisio,nbpublic,hrpublic,nbdomicile,hrdomicile,nbJours,nbMois,premierRdv,deuxiemeRdv,prvisio,prpublic,prdomicile,Emetteur) values(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)');        $req1->execute(array(floatval($amount),$image,$packname,$nbvisio,floatval($hrvisio),$nbpublic,floatval($hrpublic),$nbdomicile,floatval($hrdomicile),$nbJours,$nbMois,floatval($premierRdv),floatval($deuxiemeRdv),floatval($prvisio),floatval($prpublic),floatval($prdomicile),$iduser));        $id = $bdd->lastInsertId();        if(count($extras)>0){            //pour enregistrer les jours travaillé en jours feriés et weekend            foreach ($extras as $key => $value) {                $req=$bdd->prepare('insert into pack_extras(extra,pack_id) values(?,?)');                $req->execute(array($value,$id));            }        }    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er,'dta' =>  $id  ));}/////////////////////////////modifier un packif(isset($_POST["savepack"]) and ($_COOKIE['usertype']=='admin' or $_COOKIE['usertype']=='user' )){    $obj = json_decode($_POST["savepack"]);    $iduser = $_COOKIE['iduser'];    if($_COOKIE['usertype']=='user'){        $req2=$bdd->prepare('select * from user_acl where iduser =?');        $req2->execute(array(intval($_COOKIE['iduser'])));        while($ar2 = $req2->fetch()){$iduser = $ar2['idadmin'];}    }    $packname=trim(strip_tags($obj->packname));    $idpack=trim(strip_tags($obj->idpack));    $nbvisio=trim(strip_tags($obj->nbvisio));    $hrvisio=trim(strip_tags($obj->hrvisio));    $nbpublic=trim(strip_tags($obj->nbpublic));    $hrpublic=trim(strip_tags($obj->hrpublic));    $nbdomicile=trim(strip_tags($obj->nbdomicile));    $hrdomicile=trim(strip_tags($obj->hrdomicile));    $nbJours=trim(strip_tags($obj->nbJours));    $nbMois=trim(strip_tags($obj->nbMois));    $premierRdv=trim(strip_tags($obj->premierRdv));    $deuxiemeRdv=trim(strip_tags($obj->deuxiemeRdv));    $prvisio=trim(strip_tags($obj->prvisio));    $prpublic=trim(strip_tags($obj->prpublic));    $prdomicile=trim(strip_tags($obj->prdomicile));    $amount=trim(strip_tags($obj->amount));    $image=trim(strip_tags($obj->image));    $extras=$obj->extras;    if($idpack == "" ){        $err .= '<p>* l\'identifiant du pack est invalide.</p><br />';$er = '1';    }    if($packname == "" ){        $err .= '<p>* Veuillez ecrire Le nom de pack.</p><br />';$er = '1';    }    if($nbMois == '0' and $nbJours == '0'  ){        $err .= '<p>* Veuillez Choisir la durée en jours ou mois ou les deux.</p><br />';$er = '1';    }    if($er == '0'){        $req1=$bdd->prepare('UPDATE packs set amount=?,picture=?, packname=?,nbvisio=?,hrvisio=?,nbpublic=?,hrpublic=?,nbdomicile=?,hrdomicile=?,nbJours=?,nbMois=?,premierRdv=?,deuxiemeRdv=?,prvisio=?,prpublic=?,prdomicile=?,Emetteur=? where idpack=?');        $req1->execute(array(floatval($amount),$image,$packname,$nbvisio,floatval($hrvisio),$nbpublic,floatval($hrpublic),$nbdomicile,floatval($hrdomicile),$nbJours,$nbMois,floatval($premierRdv),floatval($deuxiemeRdv),floatval($prvisio),floatval($prpublic),floatval($prdomicile),$iduser,$idpack));        if(count($extras)>0){            $reqx=$bdd->prepare('delete from pack_extras');            $reqx->execute();            //pour enregistrer les jours travaillé en jours feriés et weekend            foreach ($extras as $key => $value) {                $req=$bdd->prepare('insert into pack_extras(extra,pack_id) values(?,?)');                $req->execute(array($value,$idpack));            }        }    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er,'dta' =>  $idpack  ));}/////////////////////////////////////recevoir les infos d'un pack pour le modifier aprésif(isset($_POST["editpack"]) and ($_COOKIE['usertype']=='admin' or $_COOKIE['usertype']=='user' )){    $obj = json_decode($_POST["editpack"]);    $iduser = $_COOKIE['iduser'];    $kim= array();    $idpack=trim(strip_tags($obj->idpack));    if($_COOKIE['usertype']=='user'){        $req2=$bdd->prepare('select * from user_acl where iduser =?');        $req2->execute(array(intval($_COOKIE['iduser'])));        while($ar2 = $req2->fetch()){$iduser = $ar2['idadmin'];}    }    if($idpack == "" ){        $err .= '<p>* l\'identifiant du pack est invalide.</p><br />';$er = '1';    }    if($er != '1'){        //pour trouver le pack        $req4=$bdd->prepare("select * from packs where idpack=? and Emetteur=?");        $req4->execute(array($idpack,intval($iduser)));        $dta = $req4->fetchAll(\PDO::FETCH_ASSOC);        $req5=$bdd->prepare("select * from pack_extras where pack_id=?");        $req5->execute(array($idpack));        while($ar2=$req5->fetch()){           array_push($kim,$ar2['extra']);        }        array_push($dta,$kim);    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er,'dta'=> $dta));}//////////////////////////////////supprimer un packif(isset($_POST["delpack"]) and ($_COOKIE['usertype']=='admin' or $_COOKIE['usertype']=='user' ) ){    $obj = json_decode($_POST["delpack"]);    $iduser = $_COOKIE['iduser'];    $idpack=trim(strip_tags($obj->idpack));    if($_COOKIE['usertype']=='user'){        $req2=$bdd->prepare('select * from user_acl where iduser =?');        $req2->execute(array(intval($_COOKIE['iduser'])));        while($ar2 = $req2->fetch()){$iduser = $ar2['idadmin'];}    }    if($er == '0'){        $req4=$bdd->prepare("delete from packs where idpack=? and Emetteur =? ");        $req4->execute(array($idpack,$iduser));        $rows = $req4->rowcount();    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er ));}/////////////////////////////////////////////////////////////recevoir les infos d'une question pour la modifier aprésif(isset($_POST["editquestion"]) and ($_COOKIE['usertype']=='admin' or $_COOKIE['usertype']=='user' )){    $obj = json_decode($_POST["editquestion"]);    $iduser = $_COOKIE['iduser'];    $idquestion=trim(strip_tags($obj->idquestion));    if($_COOKIE['usertype']=='user'){        $req2=$bdd->prepare('select * from user_acl where iduser =?');        $req2->execute(array(intval($_COOKIE['iduser'])));        while($ar2 = $req2->fetch()){$iduser = $ar2['idadmin'];}    }    if($idquestion == "" ){        $err .= '<p>* l\'identifiant de question est invalide.</p><br />';$er = '1';    }    if($er != '1'){        //pour trouver le pack        $req4=$bdd->prepare("select * from questions where idq=? ");        $req4->execute(array($idquestion));        $dta = $req4->fetchAll(\PDO::FETCH_ASSOC);        //pour trouver les choix        $req5=$bdd->prepare("select * from choix where idquestion=? ");        $req5->execute(array($idquestion));        $dta2 = $req5->fetchAll(\PDO::FETCH_ASSOC);        //pour verifier si'il ya des reponses        $req6=$bdd->prepare("select * from reponses where idq=? ");        $req6->execute(array($idquestion));        $dta3 = $req6->rowcount();    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er,'dta' =>  $dta,'dta2' => $dta2,'dta3' => $dta3  ));}//////////////////////////////////ajouter une questionif(isset($_POST["question"]) and ($_COOKIE['usertype']=='admin' or $_COOKIE['usertype']=='user' )){    $obj = json_decode($_POST["question"]);    $iduser = $_COOKIE['iduser'];    if($_COOKIE['usertype']=='user'){        $req2=$bdd->prepare('select * from user_acl where iduser =?');        $req2->execute(array(intval($_COOKIE['iduser'])));        while($ar2 = $req2->fetch()){$iduser = $ar2['idadmin'];}    }    $question=trim(strip_tags($obj->question));    $choix1=trim(strip_tags($obj->choix1));    $choix2=trim(strip_tags($obj->choix2));    $choix3=trim(strip_tags($obj->choix3));    $typeq=trim(strip_tags($obj->typeq));    $categorie=trim(strip_tags($obj->categorie));    $pack=trim(strip_tags($obj->pack));    if($question == "" ){        $err .= '<p>* Veuillez ecrire Votre question.</p><br />';$er = '1';    }    if($choix1 == "" or $choix2 == "" or $choix3 == ""  ){        $err .= '<p>* Veuillez remplir les 3 choix.</p><br />';$er = '1';    }    if($er == '0'){        $req1=$bdd->prepare('insert into questions(question,typeq,idCategorie,id_Emetteur,packid) values(?,?,?,?,?)');        $req1->execute(array($question,$typeq,$categorie,$iduser,$pack));        $id = $bdd->lastInsertId();        $req1=$bdd->prepare('insert into choix(idquestion,choix) values(?,?)');        $req1->execute(array($id,$choix1));        $req1=$bdd->prepare('insert into choix(idquestion,choix) values(?,?)');        $req1->execute(array($id,$choix2));        $req1=$bdd->prepare('insert into choix(idquestion,choix) values(?,?)');        $req1->execute(array($id,$choix3));    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er,'dta' =>  $id  ));}//modifier une questionif(isset($_POST["savequestion"]) and ($_COOKIE['usertype']=='admin' or $_COOKIE['usertype']=='user' )){    $obj = json_decode($_POST["savequestion"]);    $iduser = $_COOKIE['iduser'];    if($_COOKIE['usertype']=='user'){        $req2=$bdd->prepare('select * from user_acl where iduser =?');        $req2->execute(array(intval($_COOKIE['iduser'])));        while($ar2 = $req2->fetch()){$iduser = $ar2['idadmin'];}    }    $question=trim(strip_tags($obj->question));    $idquestion=trim(strip_tags($obj->idquestion));    $choix1=trim(strip_tags($obj->choix1));    $choix2=trim(strip_tags($obj->choix2));    $choix3=trim(strip_tags($obj->choix3));    $idchoix1=trim(strip_tags($obj->idchoix1));    $idchoix2=trim(strip_tags($obj->idchoix2));    $idchoix3=trim(strip_tags($obj->idchoix3));    $typeq=trim(strip_tags($obj->typeq));    $categorie=trim(strip_tags($obj->categorie));    $pack=trim(strip_tags($obj->pack));    if($question == "" ){        $err .= '<p>* Veuillez ecrire Votre question.</p><br />';$er = '1';    }    if($idquestion == "" ){        $err .= '<p>* l\'identifiant de la question est invalide.</p><br />';$er = '1';    }    if($choix1 == "" or $choix2 == "" or $choix3 == ""  ){        $err .= '<p>* Veuillez remplir les 3 choix.</p><br />';$er = '1';    }    if($er == '0'){        $req1=$bdd->prepare('Update questions set question=?,typeq=?,idCategorie=?,id_Emetteur=?,packid=? where idq=?');        $req1->execute(array($question,$typeq,$categorie,$iduser,$pack,$idquestion));        $req1=$bdd->prepare('Update choix set choix=? where idchoix=? and idquestion=?');        $req1->execute(array($choix1,$idchoix1,$idquestion));        $req1=$bdd->prepare('Update choix set choix=? where idchoix=? and idquestion=?');        $req1->execute(array($choix2,$idchoix2,$idquestion));        $req1=$bdd->prepare('Update choix set choix=? where idchoix=? and idquestion=?');        $req1->execute(array($choix3,$idchoix3,$idquestion));    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er  ));}//supprimer une questionif(isset($_POST["delquestion"]) and ($_COOKIE['usertype']=='admin' or $_COOKIE['usertype']=='user' )){    $obj = json_decode($_POST["delquestion"]);    $iduser = $_COOKIE['iduser'];    $idquestion=trim(strip_tags($obj->idquestion));    if($_COOKIE['usertype']=='user'){        $req2=$bdd->prepare('select * from user_acl where iduser =?');        $req2->execute(array(intval($_COOKIE['iduser'])));        while($ar2 = $req2->fetch()){$iduser = $ar2['idadmin'];}    }    if($er == '0'){        $req4=$bdd->prepare("select * from reponses where id_res=? ");        $req4->execute(array($idquestion));        $rows = $req4->rowcount();        if($_COOKIE['usertype']!='client' and intval($rows == 0)){            $req1=$bdd->prepare('delete from questions where idq = ? and id_Emetteur=? ');            $req1->execute(array($idquestion,$iduser));        }    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er ));}//reserver une conferenceif(isset($_POST["conference"])){    $obj = json_decode($_POST["conference"]);    $iduser = $_COOKIE['iduser'];    $idconference=trim(strip_tags($obj->idconference));    $datedebut=trim(strip_tags($obj->datedebut));    $datefin=trim(strip_tags($obj->datefin));    $typerdv=trim(strip_tags($obj->typerdv));    $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d H:i:s', strtotime($date));    $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d H:i:s', strtotime($date));    $datet1 = strtotime($datedebut);    $datet2 = strtotime($datefin);    $hours = round(floatval(($datet2 - $datet1) / 3600),2)   ;    if(intval(strtotime($datedebut))  > intval(strtotime($datefin)) or ((strtotime($datefin)) - intval(strtotime($datedebut)) ==0 )){        $err .= '* Veuillez choisir l\'heure de debut et l\'heure de fin';        $er = '1';    }    if(intval(strtotime($datedebut))  < intval(strtotime(date("Y-m-d H:i:s")) )){        $err .= '* Veuillez choisir une date superieure à la date actuelle';        $er = '1';    }    if(!is_numeric($idconference)){        $err .= '<p>* Veuillez cliquer sur une conférence </p><br />';$er = '1';    }    if($er == '0'){        //voir si l'interval respecte l'interval de la conference d'abord        $req=$bdd->prepare('select * from rendezvous where dateStart <= ? and dateEnd >= ? and idr = ?');        $req->execute(array($datedebut,$datefin,$idconference));        $rows = intval($req->rowcount());        if($rows != 0) {            //compter le nombre de reservations pour ce type de rdv pour voir si c'est le premier rdv ou pas            $req = $bdd->prepare('select * from reservations where idc = ? and typerdv = ? ');            $req->execute(array($iduser, $typerdv));            $trdv = $req->rowcount();            if ($trdv >= 1) {                if ($hours > 0.5) {                    $er = '1';                    $err = 'vous ne devez pas dépasser une demi heure pour ce Rdv';                }            } else if ($trdv == 0) {                if ($hours > 1) {                    $er = '1';                    $err = 'vous ne devez pas dépasser une heure pour ce Rdv';                }            }            if ($er == '0'){                //vérifier si cette interval d'heure n'est pas present ou dejà reservé                $req1 = $bdd->prepare('select * from reservations where idconference = ?');            $req1->execute(array($idconference));            while ($ar = $req1->fetch()) {                if (($datedebut < $ar['startrdv'] and $datefin <= $ar['startrdv']) or ($datedebut >= $ar['endrdv'] and $datefin > $ar['endrdv'])) {                    $rows = 'available';                } else {                    $err .= '<p>* cet interval n\'est pas disponible veuillez choisir un autre </p><br />';                    $er = '1';                }            }            if ($er == '0') {                //inserer le reservation                $req1 = $bdd->prepare('insert into reservations(idconference,startrdv,endrdv,idc,paid,typerdv) values(?,?,?,?,1,?)');                $req1->execute(array($idconference, $datedebut, $datefin, $iduser, $typerdv));                $id = $bdd->lastInsertId();            }        }        }else{            $err .= '<p>* Veuillez respecter la disponibilité du rendez-vous </p><br />';$er = '1';        }    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er,'dta' =>  $id  ));}//supprimer une reservations if(isset($_POST["datav"])){    $obj = json_decode($_POST["datav"]);    $iduser = $_COOKIE['iduser'];    if($_COOKIE['usertype']=='user'){        $req2=$bdd->prepare('select * from user_acl where iduser =?');        $req2->execute(array(intval($_COOKIE['iduser'])));        while($ar2 = $req2->fetch()){$iduser = $ar2['idadmin'];}    }    $idreservation=trim(strip_tags($obj->idreservation));    if($er == '0'){		if($_COOKIE['usertype']!='client'){		$req1=$bdd->prepare('delete from rendezvous where idr = ? and idEmetteur=? ');        $req1->execute(array($idreservation,$iduser)); 		}           }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er ));}//accepter une reservationsif(isset($_POST["datvac"])){    $obj = json_decode($_POST["datvac"]);    $iduser = $_COOKIE['iduser'];    if($_COOKIE['usertype']=='user'){        $req2=$bdd->prepare('select * from user_acl where iduser =?');        $req2->execute(array(intval($_COOKIE['iduser'])));        while($ar2 = $req2->fetch()){$iduser = $ar2['idadmin'];}    }    $idreservation=trim(strip_tags($obj->idreservation));    if($er == '0'){        if($_COOKIE['usertype']=='admin'){            $req2 = $bdd->prepare('select * from reservations where idreservation = ?');            $req2->execute(array($idreservation));            while($ars = $req2->fetch()){$idconference = $ars['idconference']; $idclient = $ars['idc'] ;}            $req1=$bdd->prepare('update rendezvous set idClient = ?,paid = 1 where idr = ? ');            $req1->execute(array($idclient,$idconference));            //pour supprimer la reservation apres elles est accepté ou payé//            $req1=$bdd->prepare('delete from reservations where idreservation = ? and idc=? ');//            $req1->execute(array($idreservation,$iduser));        }        else{  $err="vous n'êtes pas Permis à accepter une réservation"; $er= '1'; $suc = '0'; }    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er ));}