<?phpinclude('config.php');include ('../cookie.php');if( empty($_COOKIE["usertype"])){ $a="login.php";} else{$a="payer.php";};$suc ='1';$er='0';$err='';$id ='';$json =[];$rows =[];$val ='';$heures =  array();$heures2 = array();$iduser='';if(isset($_POST["load"])){$obj = json_decode($_POST["load"]);$day1=trim(strip_tags($obj->day1));$date1=trim(strip_tags($obj->date1));    $dat1 = date('Y-m-d', strtotime($date1));    if(isset($_COOKIE['iduser'])){        $iduser = $_COOKIE['iduser'];}$req1=$bdd->prepare("select * from rendezvous where DATE_FORMAT(dateStart,'%Y-%m-%d') = ?");$req1->execute(array($dat1));    while ($ar = $req1->fetch()) {        $datedebut = date('Y-m-d', strtotime($ar['dateStart']));        $datefin = date('Y-m-d', strtotime($ar['dateEnd']));        $datedebut2 = date('Y-m-d H:i:s', strtotime($ar['dateStart']));$h1 = date('H', strtotime($ar['dateStart']));$m1 = date('i', strtotime($ar['dateStart']));        $datefin2 = date('Y-m-d H:i:s', strtotime($ar['dateEnd']));$h2 = date('H', strtotime($ar['dateEnd']));$m2 = date('i', strtotime($ar['dateEnd']));        $date1 = date_create($datedebut2);        $date2 = date_create($datefin2);        $diff = date_diff($date1, $date2);        $m = $diff->i;        $h = $diff->h;        $d = date('d', strtotime($ar['dateStart']));        $td='';$td1='';$dh='';$dm=''; $td2='';        $hour1 = date('H:i:s', strtotime($ar['dateStart']));        $hour2 = date('H:i:s', strtotime($ar['dateEnd']));        if(intval($h1) == '00' ){ $h1=0; }if(intval($h2) == '00' ){ $h2=0; }        if(intval($h1) < 10 and $h1 != 0){ $h1=str_replace('0','',$h1); }if(intval($h2) < 10 and $h2 != 0 ){ $h2=str_replace('0','',$h2); }        $h1 = intval($h1);        $h2 = intval($h2);        $req2 = $bdd->prepare("select * from reservations  where  idconference = ?");        $req2->execute(array($ar['idr']));        $nbr=$req2->rowCount();        while ($ar2 = $req2->fetch()) {            $newarr = array();            $ah1 = date('H', strtotime($ar2['startrdv']));$am1 = date('i', strtotime($ar2['startrdv']));            $ah2 = date('H', strtotime($ar2['endrdv']));$am2 = date('i', strtotime($ar2['endrdv']));            $newarr[intval($ah1)] = $ah2;            $addrow='';            $addrow2='';            $lastp = 0;            $tab = '';            for($i=$h1;($i+1)<=$h2;$i++){                $disp ='';$det ='';                if($i<=$ah1 and (($i+1) > $ah1 or ( ($i+1) >= $ah1 and $am2>$am1)) and array_key_exists($i,$newarr) ){                    if(($m1 == '00' or $m1 == $m2)  ){$val .= 'ligne50-'.$i.'/'.$m1.'-'.$m2;$td1 = $i.'h'.$m1.' - '.($i+1).'h'.$m1;  $av = 'Non disponible';$disp='Non disponible';$dh=$i;$dm='00';}                        else{                            if($i < $h2 ){ $min = $m1; $newh = ($i+1);}else{$min = $m2;$newh = $i;}                            if(($h2-$i)==1 ){  if($m2<$m1){$min = $m2; $lastp = 1;}else{$min = $m1;                                $td2 = $h2.'h'.$m1.' - '.$h2.'h'.$m2;$av = 'Non disponible';$disp='Non disponible';                                if(($i+1) >= $ah1 and $am2>=$am1){                                    $lastp = 1;                                    $addrow = '<td> <div class="txt-block"><time > <i class="fa fa-clock-o" aria-hidden="true"></i>'.$td2.'</time>                                             </div> <a href="#" id="'.$ar['idr'].'" class="reserver btn text-uppercase" data-mf="'.$td2.'" data-mf="'.$h2.'" data-hf="'.$m2.'" data-m="'.$m1.'" data-date="'.$datedebut.'">'.$av.'</a> </td>';                                }                            }}                            if($av== 'Non disponible' ){                                if($addrow != ''){                                    $heures2[$td2] = $addrow;}                                else{$heures2[$td2] = $tab;}                            }                            if(($i+1)==$h2 and $lastp==1 and $m1<$m2){                                $td2 = $i.'h'.$m1.' - '.$h2.'h'.$m1;$av = 'Réserver un RDVz';                                if($m2<$m1){                                $td2 = ($i+1).'h'.$m2.' - '.$h2.'h'.$m1;$av = 'Réserver un RDVw';                                }                                $tab ='<td> <div class="txt-block"><time > <i class="fa fa-clock-o" aria-hidden="true"></i>'.$td2.'</time>                                     </div> <a href="#" id="'.$ar['idr'].'" class="reserver avail btn text-uppercase" data-mf="'.$td2.'" data-hf="'.$m2.'" data-h="'.$h2.'" data-m="'.$m1.'" data-date="'.$datedebut.'">'.$av.'</a> </td>';                                $td .= $tab;                                if(array_key_exists($td1, $heures)){                                    if($disp== 'Non disponible' ){                                        $heures[$td1] = $tab;}                                }else{                                    $heures[$td1] = $tab;                                }                            }                            if(($h2-$i) == 1 and $lastp != 1){ if($m2<$m1){$min = $m2;}else{$min = $m1;}                                $td2 = $h2.'h'.$m1.' - '.$h2.'h'.$m2;$av = 'Réserver un RDVzz';                                    $addrow ='<td> <div class="txt-block"><time > <i class="fa fa-clock-o" aria-hidden="true"></i>'.$td2.'</time>                             </div> <a href="#" id="'.$ar['idr'].'" class="reserver avail btn text-uppercase" data-mf="'.$td2.'" data-hf="'.$m2.'" data-h="'.$h2.'" data-m="'.$m1.'" data-date="'.$datedebut.'">'.$av.'</a> </td>';                            }                            $td1 = $i.'h'.$m1.' - '.$newh.'h'.$min;                            $av = 'Non disponible';                            $dh=$i;$dm=$m1;                        }                        if($i<$h2 and  $am2<=$am1){                        $tab ='<td> <div class="txt-block"><time >  <i class="fa fa-clock-o" aria-hidden="true"></i>'.$td1.'</time>                             </div> <a href="#" id="'.$ar['idr'].'" class="btn text-uppercase" data-mf="'.$td1.'" data-hf="'.$m2.'" data-h="'.$dh.'" data-m="'.$dm.'" data-date="'.$datedebut.'">'.$av.'</a> </td>';                         $td .= $tab;                        if(array_key_exists($td1, $heures)){                                if($disp== 'Non disponible' ){                                    $heures[$td1] = $tab;}                            }else{                                $heures[$td1] = $tab;                            }                        }                    if(($ah1==$ah2 and  $m1==$m2 and $am1 != $am2) or ($ah1==$ah2 and  $m1!=$m2 and $am1 != $am2) ){                        $det ='Non disponiblee';                        $tab ='<td> <div class="txt-block"><time >  <i class="fa fa-clock-o" aria-hidden="true"></i>'.$td1.'</time>                             </div> <a href="#" id="'.$ar['idr'].'" class="btn text-uppercase" data-mf="'.$td1.'" data-hf="'.$min.'" data-h="'.$dh.'" data-m="'.$dm.'" data-date="'.$datedebut.'">'.$av.'</a> </td>';                        $td .= $tab;                        if(array_key_exists($td1, $heures)){                            if($av== 'Non disponible' ){                                $heures[$td1] = $tab;}                        }else{                            $heures[$td1] = $tab;                        }                    }                    if($td2!=''){                        if(array_key_exists($td2, $heures)){                            if($disp== 'Non disponible' ){                                $heures[$td2] = $addrow;}                        }else{                            $heures[$td2] = $addrow;                        }                    }                        $td .= $addrow;                    if($av== 'Non disponible' and $det =='' ){                        if($addrow != ''){                        $heures2[$td1] = $addrow;}                        else{$heures2[$td1] = $tab;}                    }                    if($det== 'Non disponiblee'  ){                        if($addrow != ''){                            $heures2[$td1] = $addrow;}                        else{$heures2[$td1] = $tab;}                    }                }                else{                    $td2 ='';                    $val .= 'ligne iciiii-'.$i;                    if($m1 == '00' or $m1 == $m2){                        if(($i+1) < $h2 ){ $min = $m1; $newh = ($i+1);}else{$min = $m2;$newh = $i;}                        $td1 = $i.'h'.$m1.' - '.($i+1).'h'.$min;$av = 'Réserver un RDV1'; $dh=$i;$dm=$m1;}                    else{                        if(($i+1) < $h2 ){ $min = $m1; $newh = ($i+1);}else{$min = $m2;$newh = ($i+1);}                        if(($h2-$i)==1 ){ if($m2<$m1){$min = $m2;}else{$min = $m1;                        $td2 = $h2.'h'.$m1.' - '.$h2.'h'.$m2;$av = 'Réserver un RDV2';                        $addrow ='<td> <div class="txt-block"><time > <i class="fa fa-clock-o" aria-hidden="true"></i>'.$td2.'</time>                             </div> <a href="#" id="'.$ar['idr'].'" class="reserver btn avail text-uppercase" data-mf="'.$td2.'" data-hf="'.$m2.'" data-h="'.$h2.'" data-m="'.$m1.'" data-date="'.$datedebut.'">'.$av.'</a> </td>';                        }}                        $td1 = $i.'h'.$m1.' - '.$newh.'h'.$min;$av = 'Réserver un RDV3';                        $dh=$i;$dm=$m1;                       }                    $tab = '<td> <div class="txt-block"><time > <i class="fa fa-clock-o" aria-hidden="true"></i>'.$td1.'</time>                             </div> <a href="#" id="'.$ar['idr'].'" class="reserver btn avail text-uppercase" data-mf="'.$td1.'" data-hf="'.$min.'" data-h="'.$dh.'" data-m="'.$dm.'" data-date="'.$datedebut.'">'.$av.'</a> </td>';                        if(array_key_exists($td, $heures)){                            if($disp== 'Non disponible' ){                                $heures[$td1] = $tab;}                        }else{                            $heures[$td1] = $tab;                        }                    $td .='<td> <div class="txt-block"><time > <i class="fa fa-clock-o" aria-hidden="true"></i>'.$td1.'</time>                             </div> <a href="#" id="'.$ar['idr'].'" class="reserver btn avail text-uppercase" data-mf="'.$td1.'" data-hf="'.$min.'" data-h="'.$dh.'" data-m="'.$dm.'" data-date="'.$datedebut.'">'.$av.'</a> </td>'.$addrow;                    if($td2!=''){                        if(array_key_exists($td2, $heures)){                            if($disp== 'Non disponible' ){                                $heures[$td2] = $addrow;}                        }else{                            $heures[$td2] = $addrow;                        }                    }                    if($av== 'Non disponible' ){                        if($addrow != ''){                            $heures2[$td1] = $addrow;}                        else{$heures2[$td1] = $tab;}}                }            }        }        //le cas ou il n'y a aucune reservation il faut juste prendre touts les heures        if(intval($nbr)==0){            $addrow='';for($i=$h1;($i+1)<=$h2;$i++){                    if($m1 == '00' ){                        if($i < $h2 ){ $min = $m1;if(($h2-$i)==1){$min = $m2;} $newh = ($i+1); }else{ $min = $m1; $newh = $i;}                        $td1 = $i.'h'.$m1.' - '.$newh.'h'.$min;$av = 'Réserver un RDV5'; $dh=$i;$dm='00';}                    else{                        if(($i+1) < $h2 ){ $min = $m1; $newh = $i+1;}else{$min = $m2;$newh = ($i+1);}                        if(($h2-$i)==1 ){  if($m2<=$m1){$min = $m2;}else{$min = $m1;                            $td2 = $h2.'h'.$m1.' - '.$h2.'h'.$m2;$av = 'Réserver un RDV6';                            $addrow ='<td> <div class="txt-block"><time > <i class="fa fa-clock-o" aria-hidden="true"></i>'.$td2.'</time>                             </div> <a href="#" id="'.$ar['idr'].'" class="reserver btn avail text-uppercase" data-mf="'.$td2.'" data-hf="'.$m2.'" data-h="'.$h2.'" data-m="'.$m1.'" data-date="'.$datedebut.'">'.$av.'</a> </td>';                        }}                        $td1 = $i.'h'.$m1.' - '.$newh.'h'.$min;$av = 'Réserver un RDV4';                        $dh=$i;$dm=$m1;                    }                $tab = '<td> <div class="txt-block"><time >  <i class="fa fa-clock-o" aria-hidden="true"></i>'.$td1.'</time> </div>                        <a href='.$a.' id="'.$ar['idr'].'" class="btn --reserver avail text-uppercase" data-mf="'.$td1.'" data-hf="'.$min.'" data-h="'.$dh.'" data-m="'.$dm.'" data-date="'.$datedebut.'">'.$av.'</a> </td>';                $td .=$tab;                if(array_key_exists($td1, $heures)){                    if($av== 'Non disponible' ){                        $heures[$td1] = $tab;}                }else{                    $heures[$td1] = $tab;                }                if($td2!=''){                    if(array_key_exists($td2, $heures)){                        if($av== 'Non disponible' ){                            $heures[$td2] = $addrow;}                    }else{                        $heures[$td2] = $addrow;                    }                }                $td .='<td> <div class="txt-block"><time >  <i class="fa fa-clock-o" aria-hidden="true"></i>'.$td1.'</time> </div>                        <a href="#" id="'.$ar['idr'].'" class="btn reserver avail text-uppercase" data-mf="'.$td1.'" data-m="'.$dm.'" data-date="'.$datedebut.'">'.$av.'</a> </td>'.$addrow;            }        }        if($td!=''){        array_push($rows, $td);}    }$newtd = array();    $newtabx= array(); foreach($heures2 as $key => $value) {        if(array_key_exists($key,$heures2)){            $heures[$key] = $value;        }    }    $newtabx= array(); foreach($heures as $key => $value) {        array_push($newtd, $value);    }//$json  = ['id' => '7','title'=> 'Math',  'start'=> '2020-02-03T13:00:00', 'end'=> '2020-02-03T14:00:00','constraint' => 'businessHours','allDay' => false,'color'=> '#00ff00'];echo json_encode(array('val'=>$val,'disp' => $heures2, 'found' => $heures,'suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er,'dta' =>   $json , 'dta2' => $newtd ));}