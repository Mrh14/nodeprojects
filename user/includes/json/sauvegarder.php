<?phpinclude('config.php');function getInterventionNumber($val){    global $bdd;    $req3=$bdd->prepare('select * from intervention where fiche=?');    $req3->execute(array(intval($val)));    return $req3->rowcount();}$suc ='1';$er='0';$err='';$ret="";$cnt = '';$duree = 0;if($_COOKIE['usertype']=='admin' ){$sql= '9999 <> ?'; }else{$sql= 'operateur = ?';};if($_COOKIE['usertype']=='admin' ){$sql2= 'and 9999 <> ?'; }else{$sql2= 'and a.operateur = ?';};if(isset($_POST["fichecreate"])) {    $obj = json_decode($_POST["fichecreate"]);    $tab1 = $obj->tab1;    $tab2 = $obj->tab2;    $tab3 = $obj->tab3;    $fichec = trim(strip_tags($obj->fichec));    $dat = strval($obj->dat);    $iduser = trim(strip_tags($obj->iduser));    $str = '';    if ($_COOKIE['iduser'] == $iduser or $_COOKIE['usertype'] == 'admin') {        foreach ($tab1 as $key => $value) {            if ($value !== NULL) {                $ky = DateTime::createFromFormat("d-m-Y",$key.'-0'.$dat);                $datef = $ky->format('Y-m-d 00:00:00');                //if the absence exists or not to see if add it or just update it                $req2 = $bdd->prepare('select * from absence where (fiche =? and idop=?) and (date1 = ? and date2 = ?)');                $req2->execute(array(intval($fichec), intval($iduser), $datef, $datef));                $cnt = $req2->rowcount();                while($ar=$req2->fetch()){$id=$ar['idabs'];}                if(intval($cnt) =='0'){                    if($value!='0') {                        $req1 = $bdd->prepare('insert into absence(typeAbsence,dure,date1,date2,fiche,idop) values(?,?,?,?,?,?)');                        $req1->execute(array($tab2[$key], $value, $datef, $datef, intval($fichec), intval($iduser)));                    }                }else{                    if($value=='0'){                        $req3 = $bdd->prepare('delete from absence where (fiche =? and idop=?) and (date1 = ? and date2 = ?)');                        $req3->execute(array(intval($fichec), intval($iduser), $datef, $datef));                        $cnt = 5;                    }                    else{                    $req1 = $bdd->prepare('update absence set typeAbsence=?,dure=?,date1=?,date2=?,fiche=?,idop=? where idabs=? ');                    $req1->execute(array($tab2[$key], $value, $datef, $datef, intval($fichec), intval($iduser),intval($id)));$cnt = 6;}                }                $str = $ky;            }        }     // pour mettre à jour les jours d'astreintes        foreach ($tab3 as $key => $value) {            if ($value !== NULL) {                $ky = DateTime::createFromFormat("d-m-Y",$key.'-0'.$dat);                $datef = $ky->format('Y-m-d 00:00:00');                //if the absence exists or not to see if add it or just update it                $req2 = $bdd->prepare('select * from astreinte where (afiche =? and idop_as=?) and (debutdate = ? and findate = ?)');                $req2->execute(array(intval($fichec), intval($iduser), $datef, $datef));                $cnt = $req2->rowcount();                while($ar=$req2->fetch()){$idas=$ar['id_as'];}                if(intval($cnt) =='0'){                    if($value!='0') {                        $req1 = $bdd->prepare('insert into astreinte(debutdate,findate,afiche,idop_as) values(?,?,?,?)');                        $req1->execute(array($datef, $datef, intval($fichec), intval($iduser)));                    }                }else{                    if($value=='0'){                        $req3 = $bdd->prepare('delete from astreinte where (afiche =? and idop_as=?) and (debutdate = ? and findate = ?)');                        $req3->execute(array(intval($fichec), intval($iduser), $datef, $datef));                        $cnt = 5;                    }                    else{                        $req1 = $bdd->prepare('update astreinte set debutdate=?,findate=?,afiche=?,idop_as=? where id_as=? ');                        $req1->execute(array( $datef, $datef, intval($fichec), intval($iduser),intval($idas)));$cnt = 6;}                }                $str = $ky;            }        } //fin mise a jour astreinte    }    else{        $er =1;$err='vous \'avez pas le droit a cette fiche de controle';$suc='0';    }echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er ,'dta' =>(string)$cnt  ));}//pour valider la fiche de controleif(isset($_POST["afichecreate"])) {    $obj = json_decode($_POST["afichecreate"]);    $tab1 = $obj->tab1;    $tab2 = $obj->tab2;    $tab3 = $obj->tab3;    $fichec = trim(strip_tags($obj->fichec));    $dat = strval($obj->dat);    $iduser = trim(strip_tags($obj->iduser));    $str = '';    if ($_COOKIE['iduser'] == $iduser or $_COOKIE['usertype'] == 'admin') {        foreach ($tab1 as $key => $value) {            if ($value !== NULL) {                $ky = DateTime::createFromFormat("d-m-Y",$key.'-0'.$dat);                $datef = $ky->format('Y-m-d 00:00:00');                //if the absence exists or not to see if add it or just update it                $req2 = $bdd->prepare('select * from absence where (fiche =? and idop=?) and (date1 = ? and date2 = ?)');                $req2->execute(array(intval($fichec), intval($iduser), $datef, $datef));                $cnt = $req2->rowcount();                while($ar=$req2->fetch()){$id=$ar['idabs'];}                if(intval($cnt) ==0){                    if($value!='0') {                        $req1 = $bdd->prepare('insert into absence(typeAbsence,dure,date1,date2,fiche,idop) values(?,?,?,?,?,?)');                        $req1->execute(array($tab2[$key], $value, $datef, $datef, intval($fichec), intval($iduser)));                    }                }else{                    if($value=='0'){                        $req3 = $bdd->prepare('delete from absence where (fiche =? and idop=?) and (date1 = ? and date2 = ?)');                        $req3->execute(array(intval($fichec), intval($iduser), $datef, $datef));                        $cnt = 5;                    }                    else{                        $req1 = $bdd->prepare('update absence set typeAbsence=?,dure=?,date1=?,date2=?,fiche=?,idop=? where idabs=? ');                        $req1->execute(array($tab2[$key], $value, $datef, $datef, intval($fichec), intval($iduser),intval($id)));$cnt = 6;}                }                $str = $ky;            }        }        // pour mettre à jour les jours d'astreintes        foreach ($tab3 as $key => $value) {            if ($value !== NULL) {                $ky = DateTime::createFromFormat("d-m-Y",$key.'-0'.$dat);                $datef = $ky->format('Y-m-d 00:00:00');                //if the absence exists or not to see if add it or just update it                $req2 = $bdd->prepare('select * from astreinte where (afiche =? and idop_as=?) and (debutdate = ? and findate = ?)');                $req2->execute(array(intval($fichec), intval($iduser), $datef, $datef));                $cnt = $req2->rowcount();                while($ar=$req2->fetch()){$idas=$ar['id_as'];}                if(intval($cnt) =='0'){                    if($value!='0') {                        $req1 = $bdd->prepare('insert into astreinte(debutdate,findate,afiche,idop_as) values(?,?,?,?)');                        $req1->execute(array($datef, $datef, intval($fichec), intval($iduser)));                    }                }else{                    if($value=='0'){                        $req3 = $bdd->prepare('delete from astreinte where (afiche =? and idop_as=?) and (debutdate = ? and findate = ?)');                        $req3->execute(array(intval($fichec), intval($iduser), $datef, $datef));                        $cnt = 5;                    }                    else{                        $req1 = $bdd->prepare('update astreinte set debutdate=?,findate=?,afiche=?,idop_as=? where id_as=? ');                        $req1->execute(array( $datef, $datef, intval($fichec), intval($iduser),intval($idas)));$cnt = 6;}                }                $str = $ky;            }        }        $req5 = $bdd->prepare("update fichecontrole set etat=1 where idfiche=? and $sql");        $req5->execute(array( intval($fichec),intval($iduser)));        //fin mise a jour et validation    }    else{        $er =1;$err='vous \'avez pas le droit a cette fiche de controle';$suc='0';    }    echo json_encode(array('suc' =>  (string)$suc,'err' =>  (string)$err ,'er' =>  (string)$er ,'dta' =>(string)$cnt  ));}