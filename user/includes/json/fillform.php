<?phpinclude('config.php');$suc ='1';$er='0';$err='';$df = '';if($_COOKIE['usertype']=='admin' ){$sql= '9999 <> ?'; $sql2= '9999 <> ?';}else{$sql= 'a.operateur = ?';$sql2= 'operateur = ?';};$nom = '';$denomination = '';$dta = ''; $data ='';function getInterventionNumber($val){    global $bdd;    $req3=$bdd->prepare('select * from intervention where fiche=?');    $req3->execute(array(intval($val)));    return $req3->rowcount();}//recherche des fiche de controleif(isset($_POST['datas'])){    $obj = json_decode($_POST["datas"]);    $idclient=trim(strip_tags($obj->idclient));    $datedebut=trim(strip_tags($obj->datedebut));    $datefin=trim(strip_tags($obj->datefin));   if($idclient != ''){if($datedebut =='' and $datefin =='') { $req1=$bdd->prepare("select a.*,b.* from fichecontrole as a inner join client as b where a.client = b.idclient  and $sql and a.client=? group by a.idfiche");$req1->execute(array(intval($_COOKIE['iduser']),intval($idclient)));}else if($datedebut !='' and $datefin !='') {    $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d', strtotime($date));    $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d', strtotime($date));        $req1=$bdd->prepare("select a.*,b.* from fichecontrole as a inner join client as b where a.client = b.idclient  and $sql and a.client=? and a.datedebut >= ? and a.datefin <= ? group by a.idfiche");        $req1->execute(array(intval($_COOKIE['iduser']),intval($idclient),$datedebut,$datefin));}   }   else{   }    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    if (intval($row) == 0) {        $suc = '0';        $er = '1';        $dta = '<tr><td colspan="6">Résultat de recherche est vide</td></tr>';    }    else{        $newtabx = array();        foreach ($data as $key => $value) {            $newtabx[$key] = $value;            $newtab2 = array();            foreach ($newtabx[$key] as $key2 => $value2) {                $newtab2[$key2] = $value2;            }            if($_COOKIE['usertype']=='admin' ){$btn= '<form action="#" id="del1" method="post"><a  title="supprimer" class="typcn typcn-delete text-danger" id="dell" data-id="'.$newtabx[$key]['idfiche'].'"></a></form>';                $etat = $newtab2['etat'] == "0" ? '<select name="vld" id="vld" data-id="'.$newtab2['idfiche'].'" ><option value="0" selected>en cours</option> <option value="1">validé</option> </select>' :  ' <select name="vld" id="vld" data-id="'.$newtab2['idfiche'].'" ><option value="0" >en cours</option> <option value="1" selected>validé</option></select>';}else{$btn= '';                $etat = $newtab2['etat'] == "0" ? "en cours" :  "validé";}            $dta .= '<tr data-id="'.$newtab2['idfiche'].'"><th scope="row">'.$newtab2['idfiche'].'</th><td>'.$newtabx[$key]['nomPrenom'].'</td><td>'.$newtab2['datedebut'].'</td><td>'.$newtab2['datefin'].'</td><td>'.getInterventionNumber($newtabx[$key]['idfiche']).'</td>                                                    <td>'.$etat.'</td><td class="d-flex">                                                    <form action="interventions.php" id="del2" method="post"><a  title="Interventions" class=" typcn typcn-th-list  mdi-24px text-primary" id="delf" data-id="'.$newtabx[$key]['idfiche'].'"></a></form>                                                    <form action="interventions.php" id="del3" method="post"><a title="Ajouter" class="typcn typcn-document-add mdi-24px text-success" id="dalf" data-id="'.$newtabx[$key]['idfiche'].'"></a></form>                                                    '.$btn.'</td>                                                    <td><form action="fichecreate.php" id="fpdf" method="post"><input type="hidden" name="pdf" value="'.$newtabx[$key]['idfiche'].'" /><a type="submit" href="" id="pdf"><li class="mdi mdi-file-pdf mdi-48px" style="width:50px;height:50px;"></li></a></form></td></tr>';        }    }echo json_encode(array(    'suc' =>  (string)$suc,    'err' =>  (string)$err ,    'er' =>  (string)$er ,    'dta'      =>  $dta));}//formulaire pour supprimer une fiche de controleif(isset($_POST['datc'])){    $obj = json_decode($_POST["datc"]);    $idfiche=trim(strip_tags($obj->idfiche));    $req1=$bdd->prepare('delete from fichecontrole where idfiche=?');    $req1->execute(array(intval($idfiche)));    // supprimer aussi les intervention de cette fiche control    $req2=$bdd->prepare('delete from intervention where fiche=?');    $req2->execute(array(intval($idfiche)));    $req1=$bdd->prepare('select *  from fichecontrole where idfiche=?');    $req1->execute(array(intval($idfiche)));    $row = $req1->rowCount();    if($row == '0'){$suc = 1;$er = 0;} else{ $suc = 0;$er = 1;$err= 'la fiche de controle n\'pas été supprimé veuiller recharger la page et réssayer';}    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'cnt'      =>  $row    ));}//formulaire pour supprimer une interventionif(isset($_POST['datav'])){    $obj = json_decode($_POST["datav"]);    $idinter=trim(strip_tags($obj->idinter));    $req1=$bdd->prepare('delete  from intervention where id=?');    $req1->execute(array(intval($idinter)));    $req1=$bdd->prepare('select *  from intervention where id=?');    $req1->execute(array(intval($idinter)));    $row = $req1->rowCount();  if($row == '0'){$suc = 1;$er = 0;} else{ $suc = 0;$er = 1;$err= 'l\'intervention n\'pas été supprimé veuiller recharger la page et réssayer';}    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'cnt'      =>  $row    ));}if(isset($_POST['datavs'])){    $obj = json_decode($_POST["datavs"]);    $idclient=trim(strip_tags($obj->idclient));    $datedebut=trim(strip_tags($obj->datedebut));    $datefin=trim(strip_tags($obj->datefin));    if($idclient != ''){        if($datedebut =='' and $datefin =='') {            $req1=$bdd->prepare("select a.*,b.*, c.* from intervention as a inner join fichecontrole as b on a.fiche = b.idfiche inner join client as c on b.client = c.idclient  and $sql and c.idclient =? group by a.id ");            $req1->execute(array(intval($_COOKIE['iduser']),intval($idclient)));        }        else if($datedebut !='' and $datefin !='') {            $date = str_replace('/', '-', $datedebut);$datedebut = date('Y-m-d H:i:s', strtotime($date));            $date = str_replace('/', '-', $datefin);$datefin = date('Y-m-d H:i:s', strtotime($date));            $req1=$bdd->prepare("select a.*,b.*, c.* from intervention as a inner join fichecontrole as b on a.fiche = b.idfiche inner join client as c on b.client = c.idclient   $sql and c.idclient =? and a.dateDebut >= ? and a.dateFin <= ? ");            $req1->execute(array(intval($_COOKIE['iduser']),intval($idclient),$datedebut,$datefin));        }    }    else{    }    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    if (intval($row) == 0) {        $suc = '0';        $er = '1';        $dta = '<tr><td colspann="7">Résultat de recherche est vide</td></tr>';    }    else{        $newtabx = array();        foreach ($data as $key => $value) {            $newtabx[$key] = $value;            $newtab2 = array();            foreach ($newtabx[$key] as $key2 => $value2) {                $newtab2[$key2] = $value2;            }            $date1 = new DateTime($newtab2['dateDebut']);$date2 = new DateTime($newtab2['dateFin']);            $diff = $date1->diff($date2);$hours = $diff->i;$diff = $date1->diff($date2);$hours2 = $diff->h;$hours = ($hours / 60) + $hours2;            $dta .=     ' <tr data-id="'.$newtab2['id'].'"><th scope="row">'.$newtab2['id'].'</th><td>'.$newtab2['idfiche'].'</td><td>'.$newtabx[$key]['nomPrenom'].'</td><td>'.$newtab2['dateDebut'].'</td><td>'.$newtab2['dateFin'].'</td><td>'.number_format($hours,2).' H</td>                                                 <td>' .$newtabx[$key]['nature'].'</td><td><form action="#" id="del1" method="post"><a title="supprimer" class="typcn typcn-delete mdi-24px text-danger"  id="dell" data-id="'.$newtabx[$key]['id'].'"></a></form></td></tr>';        }    }    echo json_encode(array(        'suc' =>  (string)$suc, 'err' =>  (string)$err , 'er' =>  (string)$er , 'dta'  =>  $dta    ));}//evenement lorsque une fiche selectionner lors de la modificationif(isset($_POST['dtas'])){    $obj = json_decode($_POST["dtas"]);    $idfiche=trim(strip_tags($obj->idfiche));    $req1=$bdd->prepare("select * from fichecontrole where idfiche =? and $sql2");    $req1->execute(array(intval($idfiche),intval($_COOKIE['iduser'])));    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er ,        'dta'      =>  $data    ));}//evenement lorsque on change l'etat de la fiche de controle et enregistré l'etat selectionnéif(isset($_POST['etat'])){    $obj = json_decode($_POST["etat"]);    $idfiche=trim(strip_tags($obj->idfiche));    $etat=trim(strip_tags($obj->etat));    $req1=$bdd->prepare("update fichecontrole set etat=$etat where idfiche =? and $sql2");    $req1->execute(array(intval($idfiche),intval($_COOKIE['iduser'])));    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    echo json_encode(array(        'suc' =>  (string)$suc,        'err' =>  (string)$err ,        'er' =>  (string)$er    ));}if(isset($_POST['dtavs'])){    $obj = json_decode($_POST["dtavs"]);    $idinterv=trim(strip_tags($obj->idinterv));    $req1=$bdd->prepare("select * from intervention where id =? and $sql2");    $req1->execute(array(intval($idinterv),intval($_COOKIE['iduser'])));    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    echo json_encode(array('suc' =>  (string)$suc, 'err' =>  (string)$err , 'er' =>  (string)$er , 'dta'      =>  $data));}//procedure d'afficher les fiches de controle lorsqu'on choisis le client dans la page absencesif(isset($_POST['dtavcs'])){    $obj = json_decode($_POST["dtavcs"]);    $idclient=trim(strip_tags($obj->idclient));    $req1=$bdd->prepare("select a.*,b.* from fichecontrole as a inner join users as b on a.operateur = b.idCompte where a.operateur =? group by a.idfiche");    $req1->execute(array(intval($idclient)));    $row = $req1->rowcount();    $data = $req1->fetchAll(PDO::FETCH_ASSOC);    $newtabx = array();    foreach ($data as $key => $value) {        $newtabx[$key] = $value;        $newtab2 = array();        foreach ($newtabx[$key] as $key2 => $value2) {            $newtab2[$key2] = $value2;        }        $dta .=   ' <option value="'.$newtab2['idfiche'] .'" >'.$newtab2['nomprenom'] .' N° de fiche '.$newtab2['idfiche'] .' </option>' ;;    }    echo json_encode(array('suc' =>  (string)$suc, 'err' =>  (string)$err , 'er' =>  (string)$er , 'dta' =>  $dta));}